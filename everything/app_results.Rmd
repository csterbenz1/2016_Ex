---
title: "2016 Application"
author: "Ciara Sterbenz"
output:
  pdf_document: default
date: "4/7/2021"
editor_options: 
  chunk_output_type: console
---


```{r setup, include = F}
#rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
set.seed(9345876)

### Packages
library(tidyverse)
library(survey)
library(kbal)
library(knitr)
library(kableExtra)
```

```{r load_dat}
#loading the updated data:
path_data= "/Users/Ciara/Dropbox/kpop/Updated/application/data/"
path_weights = "/Users/Ciara/Dropbox/kpop/Updated/application/weights/"
POPW = TRUE

if(POPW) {
    cces <- readRDS(paste0(path_data, "cces_lasso.rds"))
    pew <- readRDS(paste0(path_data, "pew_lasso.rds"))
} else {
    cces <- readRDS(paste0(path_data, "cces_xgb.rds"))
    pew <- readRDS(paste0(path_data, "pew_xgb.rds"))
}

#note that all the usual minor cleaning we would do has already been performed in the app_model_outcome.Rmd that built the above files
```


```{r setup_targets}
formula_rake_demos_noeduc <- ~recode_age_bucket + recode_female + recode_race + 
    recode_region + recode_pid_3way

formula_rake_demos_weduc <- ~recode_age_bucket + recode_female + 
    recode_race + recode_region + recode_educ + recode_pid_3way

formula_rake_all_vars <- ~recode_age_bucket + recode_female + 
    recode_race + recode_region + recode_pid_3way + recode_educ +
    recode_income_5way + recode_relig_6way + recode_born + recode_attndch_4way

formula_ps <- ~recode_age_3way + recode_female + recode_race +
    recode_region + recode_educ_wh_3way + recode_pid_3way

formula_ps_reduc <- ~recode_age_3way + recode_female + 
    recode_race + recode_region + recode_pid_3way  +
    recode_income_3way + recode_born + recode_educ_wh_3way

#let's coarsen income and religion and attend church:
formula_ps_all <- ~recode_age_3way + recode_female + 
    recode_race + recode_region + recode_pid_3way + recode_educ_3way +
    recode_income_3way + recode_relig_6way + recode_born + recode_attndch_bin


formula_retrospective <- ~recode_age_bucket:recode_pid_3way + 
    recode_female:recode_pid_3way+ recode_race_educ_reg:recode_pid_3way

### set up some functions for convenient estimates
vote_contrast <- quote((recode_vote_2016Democrat - recode_vote_2016Republican) /
                               (recode_vote_2016Democrat + recode_vote_2016Republican))

vote_diff <- quote((recode_vote_2016Democrat - recode_vote_2016Republican) /(recode_vote_2016Democrat + recode_vote_2016Republican + recode_vote_2016Other)) 


#### Build Strata For PS
cces <- bind_cols(cces, cces %>% 
                      unite("strata", all.vars(formula_ps), remove = FALSE) %>%
                         unite("strata_reduc", all.vars(formula_ps_reduc), 
                               remove = FALSE) %>%
                         unite("strata_all", all.vars(formula_ps_all)) %>%
                      dplyr::select(strata, strata_reduc, strata_all))

pew <- bind_cols(pew, pew %>% 
                     unite("strata", all.vars(formula_ps), remove = FALSE) %>%
                     unite("strata_reduc", all.vars(formula_ps_reduc), 
                           remove = FALSE) %>%
                     unite("strata_all", all.vars(formula_ps_all)) %>%
                     dplyr::select(strata, strata_reduc, strata_all))

#make targets
create_targets <- function (target_design, target_formula) {
    target_mf <- model.frame(target_formula, model.frame(target_design))
    target_mm <- model.matrix(target_formula, target_mf)
    wts <- weights(target_design)
    colSums(target_mm * wts) / sum(wts)
}

```


# Margins Functions to produce latex tables

First the unadulterated margins

```{r, eval = F}
margins_formula <- ~recode_pid_3way + recode_age_bucket +
                recode_female + recode_race +recode_region + recode_educ + recode_income_5way +
    recode_relig_6way + recode_born + recode_attndch_4way 

pew_nowt <- suppressWarnings(svydesign(~1, data = pew))
cces_awt <- svydesign(~1, weights = ~commonweight_vv_post, data = cces)
cces_nowt <- svydesign(~1, data = cces)
margin_summary <- round(cbind(cces = svymean(margins_formula, cces_awt),
                              unweighted = svymean(margins_formula, pew_nowt)) * 100, 1) %>%
  data.frame() %>%
  rownames_to_column() %>%
  mutate(variable = case_when(str_detect(rowname, "age") ~ "4-way Age Bucket",
                             str_detect(rowname, "female") ~ "Gender",
                             str_detect(rowname, "race") ~ "Race/Ethnicity",
                             str_detect(rowname, "region") ~ "Region",
                             str_detect(rowname, "educ") ~ "Education Level",
                             str_detect(rowname, "income") ~ "Income",
                             str_detect(rowname, "pid") ~ "Party Identification",
                             str_detect(rowname, "relig") ~ "Religous Affiliation",
                             str_detect(rowname, "born") ~ "Born-Again Christain",
                             str_detect(rowname, "attndch") ~ "Church Attendance",
                             TRUE ~ "Empty"),
         level = 
           gsub("recode_|age_bucket|female|race|region|educ|pid_3way|relig_6way|attndch_4way|born|income_5way", "", rowname)) %>%
  select(level, everything(), -rowname, -variable)



margin_summary %>%
  mutate(level = str_replace(level, "graduate", "")) %>%
    mutate(level = str_replace(level, "\\<", "Less than ")) %>%
    mutate(level = str_replace(level, "\\>", "More than ")) %>%
  kable(format = "latex", booktabs = T,
        col.names = linebreak(
          c("", "\\belowbaseline[0ex]{\\rotatebox{90}{\\parbox{1.1in}{\\raggedright{Target (CCES)}}}}", 
          "\\belowbaseline[0ex]{\\rotatebox{90}{\\parbox{1.1in}{\\raggedright{Unweighted Pew}}}}")), 
        escape = FALSE,
        caption = "Marginal distribution, in precentage points, of important demographics for the target population and the unweighted sample") %>%
  column_spec(2:ncol(margin_summary), width = "0.45in") %>%
  column_spec(1, width = "1.45in") %>%
  kable_styling() %>%
  pack_rows("Party Identification", 1, 3, latex_gap_space = "0.5em")%>%
  pack_rows("4-way Age Bucket", 4, 7, latex_gap_space = "0.5em") %>%
  pack_rows("Gender", 8, 9, latex_gap_space = "0.5em") %>%
  pack_rows("Race/Ethnicity", 10, 13, latex_gap_space = "0.5em") %>%
  pack_rows("Region", 14, 17, latex_gap_space = "0.5em") %>%
  pack_rows("Education Level", 18, 23, latex_gap_space = "0.5em") %>%
    pack_rows("Income", 24, 29, latex_gap_space = "0.5em")%>%
    pack_rows("Religious Affiliation", 30, 34, latex_gap_space = "0.5em")%>%
    pack_rows("Born-Again Christian", 35, 36, latex_gap_space = "0.5em")%>%
    pack_rows("Church Attendance", 37, 40, latex_gap_space = "0.5em")%>%
  footnote(general = "Cells present the percentage of the population represented by each variable level.",
           threeparttable = T)


\hspace{1em}18 to 35 & 20.8 & 19.1\\
\hspace{1em}36 to 50 & 21.8 & 21.4\\
\hspace{1em}51 to 64 & 34.3 & 31.0\\
\hspace{1em}65+ & 23.1 & 28.5\\

#cces weighted:
\hspace{1em}18 to 35 & 28.7 & 19.1\\
\hspace{1em}36 to 50 & 21.3 & 21.4\\
\hspace{1em}51 to 64 & 29.9 & 31.0\\
\hspace{1em}65+ & 20.1 & 28.5\\

#old numbers are wildly different wtf
\hspace{1em}18 to 35 & 34.8 \\
\hspace{1em}36 to 50 & 22.6 \\
\hspace{1em}51 to 64 & 28.9 \\
\hspace{1em}65+ & 13.7 & 2.7 \\

test <- readRDS(paste0( "/Users/Ciara/Dropbox/kpop/application/old/cces_CS.rds"))


test_awt <- svydesign(~1, weights = ~commonweight_vv_post,data =  test)
test_nowt <- svydesign(~1, data =  test)

cces_awt <- svydesign(~1, weights = ~commonweight_vv_post, data = cces)
cces_nowt <- svydesign(~1, data = cces)

svymean(~recode_age_bucket, test_awt)
svymean(~recode_age_bucket, cces_awt)

svymean(~recode_age_bucket, cces_nowt)
svymean(~recode_age_bucket, test_nowt)



test2 <- readRDS(paste0( "/Users/Ciara/Dropbox/kpop/application/old/pew.rds"))
test2_nowt <- svydesign(~1, data = test2)
test2_awt <- svydesign(~1, weights = ~weight, data = test2)
nrow(test2)
svymean(~recode_age_bucket, pew_nowt)
svymean(~recode_age_bucket, test2_nowt)
svymean(~recode_age_bucket, test2_awt)

```


As is only works for b = argmax V(K) because I have not rerun across other b's to be able to get margins for those choices of b.

```{r margins_func}
########## Margins Function #############
allmargins <- function(pop_weights = TRUE,
                       b = NULL,
                       margins_formula = NULL, 
                       order = NULL,
                       tolerance = 1e-06,
                       pop_weighted_avg = TRUE,
                       maxit = 500) {
    
    pew_nowt <- suppressWarnings(svydesign(ids = ~1, data = pew))
    
    missing_strata <- unique(cces$strata)[!(unique(cces$strata) %in%
                                                        unique(pew$strata))]
    missing_strata_reduc <- unique(cces$strata_reduc)[!(unique(cces$strata_reduc) %in%
                                                unique(pew$strata_reduc))]
  
    missing_strata_all <- unique(cces$strata_all)[!(unique(cces$strata_all) %in%
                                                unique(pew$strata_all))]
    
    problem <- unique(pew$strata)[!(unique(pew$strata) %in%
                                                   unique(cces$strata))]
    problem_reduc <- unique(pew$strata_reduc)[!(unique(pew$strata_reduc)
                                                         %in%
                                                   unique(cces$strata_reduc))]
    
    problem_all <- unique(pew$strata_all)[!(unique(pew$strata_all) %in%
                                                   unique(cces$strata_all))]
    
    kbal_data_sampled <- c(rep(1, nrow(pew)),
                           rep(0, nrow(cces)))

     
    if(pop_weights & maxit == 500 & tolerance == 1e-06) {
        load(paste0(path_weights,"bmaxvar_cat_par_wTRUE_m500_t1e-06_2021-03-30.Rdata"))
        index = 1
        b = out_cat$b
        cat("loading: bmaxvar_cat_par_wTRUE_m500_t1e-06_2021-03-30 \n")
        
    } else if(pop_weights & maxit == 800 & tolerance == 1e-04) {
        #load("./weights/allB_cat_par_wTRUE_m800_t1e-04_2021-03-23.Rdata")
        #cat("loading: allB_cat_par_wTRUE_m800_t1e-04_2021-03-23 \n")
        stop("Not supported currenty")
        b_run <- out_cat$b
        index = which(b_run == b)
        if(length(index) == 0 ) {
            stop("Must enter b in range of b_run")
        }    
    } else if(!pop_weights & tolerance == 1e-06 & maxit == 500) {
        load(paste0(path_weights,"bmaxvar_cat_par_wFALSE_m500_t1e-06_2021-03-30.Rdata"))
        index = 1
         b = out_cat$b
        cat("loading: bmaxvar_cat_par_wFALSE_m500_t1e-06_2021-03-30 \n")
        
    } else if(!pop_weights & tolerance == 1e-04 & maxit == 800) {
        #load("/Users/Ciara/Documents/Cloud Documents/Hazlett:Hartman RA/2016 Election/allB_cat_par_wFALSE_m800_t1e-04_2021-03-23.Rdata")
        #cat("loading: allB_cat_par_wFALSE_m800_t1e-04_2021-03-23.Rdata")
        stop("Not supported currenty")
        b_run <- out_cat$b
        index = which(b_run == b)
        if(length(index) == 0 ) {
            stop("Must enter b in range of b_run")
        }
    }

    #updated for the only bmaxvar 
    kpop_w <- weights_cat[[index]]$kpop_w
    kpop_conv_w <- weights_cat[[index]]$kpop_w_conv
    kpop_mf_w <- weights_cat[[index]]$kpop_mf_w
    #kpop_demos_w <- weights_cat[[index]]$kpop_demos_w
    #kpop_demos_wedu_w <- weights_cat[[index]]$kpop_demos_weduc_w
    #kpop_all_w <- weights_cat[[index]]$kpop_all_w
    #temproray until rerun weights
    kpop_demos_w <- weights_cat[[index]]$kpop_contraint_w
    kpop_demos_wedu_w <- weights_cat[[index]]$kpop_contraint_weduc_w
    kpop_all_w <- weights_cat[[index]]$kpop_full_constraint_w
    

    b_lab = paste0("b=", round(b, 2))

    colnames_bottom = c("Variable", "Orig", "","(Demos)", "(Demos)",
                        "(Demos+Edu)", "(Demos+Edu)", "(All)",  "(All)",
                         "Retro", "Reduc")
    
    if(pop_weights) {
        cces_svy <- svydesign(ids = ~1, weights = ~commonweight_vv_post,
                          data = cces)
    } else {
        cces_svy <- suppressWarnings(svydesign(ids = ~1,
                          data = cces))
    }
    
     targets_rake_demos_noeduc <- create_targets(cces_svy,
                                                    formula_rake_demos_noeduc)
     targets_rake_demos_weduc <- create_targets(cces_svy, formula_rake_demos_weduc)
     targets_rake_all_vars <- create_targets(cces_svy, 
                                                       formula_rake_all_vars)
     targets_retrospective <- create_targets(cces_svy, formula_retrospective)
     targets_ps <- svytable(formula = ~strata,
                               design = subset(cces_svy, !(strata %in%
                                                                missing_strata)))
     targets_ps_reduc <- svytable(formula = ~strata_reduc,
                               design = subset(cces_svy, !(strata_reduc %in%
                                                                missing_strata_reduc)))
     targets_ps_all <- svytable(formula = ~strata_all,
                               design = subset(cces_svy, !(strata_all %in%
                                                                missing_strata_all)))
     
     rake_demos_noeduc <- calibrate(design = pew_nowt,
                                   formula = formula_rake_demos_noeduc,
                                   population = targets_rake_demos_noeduc,
                                   calfun = "raking")
     rake_demos_noeduc <- svydesign(~1, data = pew, 
                                   weights = weights(rake_demos_noeduc))
    
     rake_demos_weduc <- calibrate(design = pew_nowt,
                                  formula = formula_rake_demos_weduc,
                                  population = targets_rake_demos_weduc,
                                  calfun = "raking")
     rake_demos_weduc <- svydesign(~1, data = pew, 
                                  weights = weights(rake_demos_weduc))
    
     rake_all_vars <- calibrate(design = pew_nowt,
                                  formula = formula_rake_all_vars,
                                  population = targets_rake_all_vars,
                                  calfun = "raking")
     rake_all_vars <- svydesign(~1, data = pew, 
                                  weights = weights(rake_all_vars))
    
    #post stratification
    pew_ps <- suppressWarnings(svydesign(ids = ~1, 
                            data = pew %>% filter(!(strata %in% problem))))
    post_stratification <- postStratify(design = pew_ps,
                                        strata = ~strata,
                                        population = targets_ps)
    post_stratification <- svydesign(~1, data = pew %>% 
                                         filter(!(strata %in% problem)),
                                     weights = weights(post_stratification))
    #reduced
    pew_ps_reduc_xgb <- suppressWarnings(svydesign(ids = ~1, data = pew %>% 
                                      filter(!(strata_reduc %in% problem_reduc))))
    post_strat_reduc <- postStratify(design = pew_ps_reduc_xgb,
                                        strata = ~strata_reduc,
                                        population = targets_ps_reduc)
    post_strat_reduc <- svydesign(~1, data = pew %>%
                                      filter(!(strata_reduc %in% problem_reduc)),
                                     weights = weights(post_strat_reduc))
    
    pew_ps_all_xgb <- suppressWarnings(svydesign(ids = ~1,  data = pew %>%  
                                    filter(!(strata_all %in% problem_all))))
    post_strat_all <- postStratify(design = pew_ps_all_xgb,
                                        strata = ~strata_all,
                                        population = targets_ps_all)
    post_strat_all <- svydesign(~1, data = pew %>% 
                                    filter(!(strata_all %in% problem_all)),
                                weights = weights(post_strat_all))
    
    rake_retrospective <- calibrate(design = pew_nowt,
                                    formula = formula_retrospective,
                                    population = targets_retrospective,
                                    calfun = "raking",
                                    force = TRUE)
    rake_retrospective <- svydesign(~1,
                                    data = pew,
                                    weights = weights(rake_retrospective))
    
    # kpop
    kpop <- svydesign(~1, data = pew,
                weights = kpop_w[kbal_data_sampled ==1])

    kpop_conv <- svydesign(~1, data = pew,
                               weights = kpop_conv_w[kbal_data_sampled ==1])
    
    kpop_mf <-  svydesign(~1, data = pew,
                              weights = kpop_mf_w[kbal_data_sampled ==1])

     kpop_demos <-  svydesign(~1, data = pew,
                          weights = kpop_demos_w[kbal_data_sampled ==1])
     kpop_demos_wedu <-  svydesign(~1, data = pew,
                          weights = kpop_demos_wedu_w[kbal_data_sampled ==1])
     
     kpop_all <-  svydesign(~1, data = pew,
                          weights = kpop_all_w[kbal_data_sampled ==1])
     

    
    if(is.null(margins_formula)) {
            margins_formula <- ~recode_vote_2016 +
                mod_cces_on_pew_pD + mod_cces_on_pew_pR + mod_cces_on_pew_pO +
                mod_pew_on_pew_pD + mod_pew_on_pew_pR + mod_pew_on_pew_pO + 
                recode_pid_3way + 
                recode_female + recode_race +recode_region + recode_educ +recode_relig_6way+
                recode_born + recode_attndch_4way + recode_income_5way +
                recode_age_bucket+recode_age+recode_agesq+recode_agecubed+recode_age_factor+
                recode_race_educ_reg + recode_educ_wh_3way + 
                recode_educ_pid_race +
                recode_pid_race + 
                recode_educ_pid +
                recode_midwest_edu_race +
                recode_midwest_wh_edu

          margins_formula_cces <- ~recode_vote_2016 +
            mod_cces_on_cces_pD + mod_cces_on_cces_pR + mod_cces_on_cces_pO +
            mod_pew_on_cces_pD + mod_pew_on_cces_pR + mod_pew_on_cces_pO + 
            recode_pid_3way + 
            recode_female + recode_race +recode_region + recode_educ + recode_relig_6way + 
            recode_born + recode_attndch_4way + recode_income_5way +
            recode_age_bucket + recode_age +recode_agesq+recode_agecubed+recode_age_factor +
            recode_race_educ_reg + recode_educ_wh_3way + 
            recode_educ_pid_race +
            recode_pid_race + 
            recode_educ_pid +
            recode_midwest_edu_race +
            recode_midwest_wh_edu
    }
    
    margins <- round(cbind(
        pew = svymean(margins_formula, pew_nowt),
        cces_margins = svymean(margins_formula_cces, cces_svy, 
                               na.rm =  TRUE),
        kpop = svymean(margins_formula, kpop),
        kpop_mf = svymean(margins_formula, kpop_mf),
        kpop_conv = svymean(margins_formula, kpop_conv),
        kpop_demos = svymean(margins_formula, kpop_demos),
        kpop_demos_wedu = svymean(margins_formula, kpop_demos_wedu),
        kpop_all = svymean(margins_formula, kpop_all),
        rake_demos_noeduc = svymean(margins_formula, rake_demos_noeduc),
        rake_demos_weduc = svymean(margins_formula, rake_demos_weduc),
        rake_all_vars = svymean(margins_formula, rake_all_vars),
        post_stratification = svymean(margins_formula, post_stratification),
        post_strat_reduc = svymean(margins_formula, post_strat_reduc),
        post_strat_all = svymean(margins_formula, post_strat_all),
        rake_retrospective = svymean(margins_formula, rake_retrospective)) * 100, 5)
    
    rownames(margins) <- sapply(rownames(margins), 
                                       function(x) (
                                           if(grepl("recode", x)) {
                                               substr(x, 8,nchar(x) )
                                           } else {
                                               x
                                           }
                                       ) )
    #we multiplied the recode_age margins by 100 unnecc above bc it' just a straight mean
    #so let's undo that
    margins["age",] <- margins["age",]/100 
    margins["agesq",] <- margins["agesq",]/100
    margins["agecubed",] <- margins["agecubed",]/100


    margins_diff <- as.data.frame(margins) %>% 
        mutate(pew = cces_margins - pew,
               kpop = cces_margins - kpop,
               kpop_mf = cces_margins - kpop_mf,
               kpop_conv = cces_margins - kpop_conv,
               kpop_demos = cces_margins - kpop_demos,
              kpop_demos_wedu =cces_margins - kpop_demos_wedu,
               kpop_all = cces_margins - kpop_all,
               rake_demos_noeduc = cces_margins- rake_demos_noeduc,
               rake_demos_weduc = cces_margins- rake_demos_weduc,
               rake_all_vars = cces_margins - rake_all_vars,
               post_stratification = cces_margins-  post_stratification,
               post_strat_reduc = cces_margins-  post_strat_reduc,
               post_strat_all = cces_margins-  post_strat_all,
               rake_retrospective = cces_margins- rake_retrospective)
    rownames(margins_diff) <- rownames(margins)
    
    
    if(pop_weighted_avg) {
        #weighting the difference by the proportion in that bin in cces
        #margins_diff is in percents, so it's the percent difference btwn the sample and the pop on each margin, we want tottake the averge abs value of this differnce, but we dont' just want the straight average, we want it weighted by the percent in that margin in the cces
        #so that means if we just multiply the idfference by the cces margin/100 we only need to sum them in wmabserr
        w_margins_diff <- margins_diff*(margins[, "cces_margins"]/100)
        #dont's square cces:
        w_margins_diff[, "cces_margins"] <- margins_diff[, "cces_margins"]
        #manugally fix the one level margins: then we'll just report the abs diff on these
        w_margins_diff["age",] <- margins_diff["age",]
        w_margins_diff["agesq",] <- margins_diff["agesq",]
        w_margins_diff["agecubed",] <- margins_diff["agecubed",]

    
        wmabserr <- w_margins_diff %>% 
            mutate(var = sapply(rownames(margins_diff), 
                                function(y) {
                                    substr(y, 1, 
                                           sapply(rownames(margins_diff), 
                                                  function(x) {
                                                      if(grepl("income",x)) {
                                                          11 #income_5way
                                                     #this is so ridiculous WHY (sunk cost ugh)
                                                      } else if(grepl("xgb",x) |grepl("mod",x) |
                                                                (grepl("age",x) & 
                                                                 !grepl("bucket",x) &
                                                                 !grepl("factor",x)) ){
                                                          nchar(x) #keep all xgb stuff
                                                          #THIS IS SO STUPID
                                                      } else if(grepl("factor",x)) {
                                                          10 #age_factor
                                                      } else {
                                                       (gregexpr("[A-Z]|[1-9][1-9] |[1-9][1-9]\\+|[1-9]\\-", x)[[1]][1]-1)
                                                      }
                                                  })[y])
                                })) %>%
            group_by(var) %>% summarize(pew_unweighted = sum(abs(pew)), 
                                        kpop = sum(abs(kpop)),
                                        #kpop_conv = sum(abs(kpop_conv)), 
                                        #kpop_mf = sum(abs(kpop_mf)),
                                        kpop_demos = sum(abs(kpop_demos)),
                                        rake_demos_noeduc = sum(abs(rake_demos_noeduc)),
                                        kpop_demos_wedu = sum(abs(kpop_demos_wedu)),
                                        rake_demos_weduc = sum(abs(rake_demos_weduc)),
                                        kpop_all = sum(abs(kpop_all)),
                                        rake_all_vars = sum(abs(rake_all_vars)), 
                                        rake_retrospective = sum(abs(rake_retrospective)),
                                        #post_stratification =
                                        #    sum(abs(post_stratification)),
                                        post_strat_reduc = sum(abs(post_strat_reduc))
                                        #post_strat_all = sum(abs(post_strat_all)),
                                        )
           wmabserr$var[wmabserr$var == "educ"]<- "educ_6way"
    
    } else {
        #get cces proportions: for weighted L1 dist on age 
        margins_diff[(grep("age_factor", rownames(margins_diff))), ] <-
          (margins_diff[(grep("age_factor", 
                              rownames(margins_diff))),
                        ])* (margins[grep("age_factor", rownames(margins)), "cces_margins"]/100)*length(levels(cces$recode_age_factor))
        
        #HAHAHHAHAHAHA this is horrific I should switch to str_extract now that i belatedly discovered it
        wmabserr <- margins_diff %>% 
        mutate(var = sapply(rownames(margins_diff), 
                            function(y) {
                                substr(y, 1, 
                                       sapply(rownames(margins_diff), 
                                              function(x) {
                                                  if(grepl("income",x)) {
                                                      11 #income_5way
                                                 #this is so ridiculous WHY (sunk cost ugh)
                                                  } else if(grepl("xgb",x) |grepl("mod",x) |
                                                            (grepl("age",x) & 
                                                             !grepl("bucket",x) &
                                                             !grepl("factor",x)) ){
                                                      nchar(x) #keep all xgb stuff
                                                      #THIS IS SO STUPID
                                                  } else if(grepl("factor",x)) {
                                                      10 #age_factor
                                                  } else {
                                                   (gregexpr("[A-Z]|[1-9][1-9] |[1-9][1-9]\\+|[1-9]\\-", x)[[1]][1]-1)
                                                  }
                                              })[y])
                            })) %>%
        group_by(var) %>% summarize(pew_unweighted = mean(abs(pew)), 
                                    kpop = mean(abs(kpop)),
                                    #kpop_conv = mean(abs(kpop_conv)), 
                                    #kpop_mf = mean(abs(kpop_mf)),
                                    kpop_demos = mean(abs(kpop_demos)),
                                    rake_demos_noeduc = mean(abs(rake_demos_noeduc)),
                                    kpop_demos_wedu = mean(abs(kpop_demos_wedu)),
                                    rake_demos_weduc = mean(abs(rake_demos_weduc)),
                                    kpop_all = mean(abs(kpop_all)),
                                    rake_all_vars = mean(abs(rake_all_vars)), 
                                    rake_retrospective = mean(abs(rake_retrospective)),
                                    #post_stratification =
                                    #    mean(abs(post_stratification)),
                                    post_strat_reduc = mean(abs(post_strat_reduc))
                                    #post_strat_all = mean(abs(post_strat_all)),
                                    )
       wmabserr$var[wmabserr$var == "educ"]<- "educ_6way"
            }
    
    
    
    
    #labels
    if(pop_weights) {
        popw_lab = "w/ Pop Weights"
    } else {
        popw_lab = "No pop Weights"
    }
    tol_label = paste0(" tol=",as.character(tolerance))
    maxit_label = paste0( " maxit=", as.character(maxit))
    
    if(pop_weighted_avg) {
        caption_m = paste0("W. Margins (Difference): Unscaled K ", "b=", round(b, 2),
                       popw_lab, " Age Buckets Only (no dnk) ",
                       tol_label, maxit_label)
        caption_o = paste0("Absolute Error on Weighted Margins of Outcomes: Unscaled K ","b=", 
                           round(b, 2),
                           popw_lab, " Age Buckets Only (no dnk) ",
                           tol_label, maxit_label)
        
        caption_err = paste0("Weighted Mean Abs Error: Unscaled K ","b=", 
                             round(b, 2), popw_lab,
                                  " Age Buckets Only (no dnk) ", tol_label, maxit_label)   
        
    } else {
        caption_m = paste0("Margins (Difference): Unscaled K ", "b=", round(b, 2),
                       popw_lab, " Age Buckets Only (no dnk) ",
                       tol_label, maxit_label)
        caption_o = paste0("Absolute Error on Margins of Outcomes: Unscaled K ","b=", 
                           round(b, 2),
                           popw_lab, " Age Buckets Only (no dnk) ",
                           tol_label, maxit_label)
        
        caption_err = paste0("Mean Abs Error: Unscaled K ","b=", 
                             round(b, 2), popw_lab,
                                  " Age Buckets Only (no dnk) ", tol_label, maxit_label)   
    }
    #var %in% c("agecubed") |
    wmabserr_nooutcomes <- wmabserr %>% 
        filter(!(grepl("xgb", var) | grepl("vote", var))) %>%
        arrange(nchar(var))
    if(is.null(order)) {
        order = c("female", "pid_3way", "age_bucket","race",  "region", "educ_6way",
                  "income_5way", "born",
                  "relig_6way", 
                  "pid_race", "educ_pid",
                  "educ_pid_race", "race_educ_reg", "educ_wh_3way", "midwest_wh_edu",
                  "midwest_edu_race",
                  
                  "agesq", "agecubed", "age_factor")
    }
    
    wmabserr_nooutcomes <- wmabserr_nooutcomes[as.numeric(sapply(order, function(x) which(wmabserr_nooutcomes$var == x))),]
    
    
    
    noedu_aes <- sapply(wmabserr_nooutcomes$var, function(x) {
            ifelse(grepl(x, as.character(formula_rake_demos_noeduc)[2]),
                   "gray", "black") })
    wedu_aes <-  sapply(wmabserr_nooutcomes$var, function(x) {
            ifelse(grepl(x, as.character(formula_rake_demos_weduc)[2]) | x == "educ_6way", "gray", "black")
        })
    all_aes <-  sapply(wmabserr_nooutcomes$var, function(x) {
            ifelse(grepl(x, as.character(formula_rake_all_vars)[2]) | x == "educ_6way", "gray", "black")
        })
    
    ps_aes <- sapply(wmabserr_nooutcomes$var, function(x) {
            ifelse(grepl(x, as.character(formula_ps)[2]), "gray", "black") })
    ps_reduc_aes <- sapply(wmabserr_nooutcomes$var, function(x) {
            ifelse(grepl(x, as.character(formula_ps_reduc)[2]), "gray", "black") })
    ps_all_aes <- sapply(wmabserr_nooutcomes$var, function(x) {
            ifelse(grepl(x, as.character(formula_ps_all)[2]), "gray", "black") })
    #interaction picks up race alone so back and fix bc does not include
    retro_aes <- sapply(wmabserr_nooutcomes$var, function(x) {
            ifelse(grepl(x, as.character(formula_retrospective)[2]) & x != "race", "gray", "black") })
    
    
    kpop_demos_aes <- noedu_aes
    kpop_demos_wedu_aes <- wedu_aes
    kpop_all_aes <- all_aes
    
    
    #change name so its clear that recode_educ is 6 way and fixing some labels that are slighly off bc i apparently could not count when i named them/less cleaning in latex names
    
    wmabserr$var[wmabserr$var == "income_5way"]<- "income_6way"
    wmabserr$var[wmabserr$var == "relig_6way"]<- "relig_5way"
    wmabserr$var[wmabserr$var == "educ_wh_3way"]<- "educ_3way_wh"
    wmabserr_nooutcomes$var[wmabserr_nooutcomes$var == "income_5way"]<- "income_6way"
    wmabserr_nooutcomes$var[wmabserr_nooutcomes$var == "relig_6way"]<- "relig_5way"
    wmabserr_nooutcomes$var[wmabserr_nooutcomes$var == "educ_wh_3way"]<- "educ_3way_wh"
    wmabserr$var[wmabserr$var == "race"]<- "race/ethnicity"
    wmabserr_nooutcomes$var[wmabserr_nooutcomes$var == "race"]<- "race/ethnicity"
    
    kable_err <- kable(wmabserr_nooutcomes,
                               format = "latex",
                               caption = caption_err,
                               booktabs = T,
                               digits = 2) %>% kable_styling() %>%
                        column_spec(which(colnames(wmabserr_nooutcomes) == "kpop_demos"),
                                color =kpop_demos_aes) %>%
                        column_spec(which(colnames(wmabserr_nooutcomes) ==
                                              "rake_demos_noeduc"),
                                color = noedu_aes) %>%
                        column_spec(which(colnames(wmabserr_nooutcomes) ==
                                              "kpop_demos_wedu"),
                                color = kpop_demos_wedu_aes) %>%
                        column_spec(which(colnames(wmabserr_nooutcomes) ==
                                              "rake_demos_weduc"),
                                color = wedu_aes) %>%
                        column_spec(which(colnames(wmabserr_nooutcomes) == "rake_all_vars"),
                                color = all_aes) %>%
                        column_spec(which(colnames(wmabserr_nooutcomes) == "kpop_all"),
                                color =kpop_all_aes) %>%
                        column_spec(which(colnames(wmabserr_nooutcomes) ==
                                              "rake_retrospective"),
                                color =retro_aes) %>% 
                        column_spec(which(colnames(wmabserr_nooutcomes) ==
                                              "post_strat_reduc"),
                                                  color =ps_reduc_aes)

     kable_om <- kable(wmabserr %>% 
                           filter( grepl("mod", var) | grepl("vote", var)) %>%
                           arrange(nchar(var)),
                           format = "latex",
                           caption = caption_o,
                           booktabs = T,
                           digits = 2)
        
            
    margins_out <- margins_diff[-c(1:9),]
    margins_out <- margins_out[!grepl("age_factor", rownames(margins_out)), ] 
    # margins_out <- margins_out %>% rbind(colMeans(margins_out))
    # rownames(margins_out)[nrow(margins_out)] <- "Column Average"
    
    out <- list(margins = margins,
                w_margins_diff = w_margins_diff,
                margins_diff = margins_diff,
                wmabserr = wmabserr,
                wmabserr_nooutcomes = wmabserr_nooutcomes,
                kable_err = kable_err,
                kable_outmom = kable_om)
    return(out)
}

```



# Run Margins

```{r margins_run}
#defaults are set to be what we usually want to look at
cat_margins_popw <- allmargins()
View(cat_margins_popw$wmabserr)
cat_margins_popw$kable_err
cat_margins_popw$kable_outmom


```



## Main Results (Simplified + Kpop with Constraints)

I chose to make this a function so so I can run it cleanly from top to bottom simply. A lot of this is redundant with what's above.
```{r res_main_funct}

main_res_plot <- function(b = "maxvar", 
                          pop_weights = TRUE,
                          specify_nonkpop = NULL,
                          specify_kpop = NULL, 
                          maxit = 500,
                          tolerance = 1e-06) {
    
    pew_nowt <- suppressWarnings(svydesign(ids = ~1, data = pew))
    pew_awt <- suppressWarnings(svydesign(ids = ~1, weights = ~weight, data = pew))
    
    missing_strata <- unique(cces$strata)[!(unique(cces$strata) %in%
                                                        unique(pew$strata))]
    missing_strata_reduc <- unique(cces$strata_reduc)[!(unique(cces$strata_reduc) %in%
                                                unique(pew$strata_reduc))]
  
    missing_strata_all <- unique(cces$strata_all)[!(unique(cces$strata_all) %in%
                                                unique(pew$strata_all))]
    
    problem <- unique(pew$strata)[!(unique(pew$strata) %in%
                                                   unique(cces$strata))]
    problem_reduc <- unique(pew$strata_reduc)[!(unique(pew$strata_reduc)
                                                         %in%
                                                   unique(cces$strata_reduc))]
    
    problem_all <- unique(pew$strata_all)[!(unique(pew$strata_all) %in%
                                                   unique(cces$strata_all))]
    
    kbal_data_sampled <- c(rep(1, nrow(pew)),
                           rep(0, nrow(cces)))

     
    if(pop_weights & maxit == 500 & tolerance == 1e-06) {
        load(paste0(path_weights,"bmaxvar_cat_par_wTRUE_m500_t1e-06_2021-03-30.Rdata"))
        index = 1
        b_num = out_cat$b
        cat("loading: bmaxvar_cat_par_wTRUE_m500_t1e-06_2021-03-30 \n")
        
    } else if(!pop_weights & tolerance == 1e-06 & maxit == 500) {
        load(paste0(path_weights,"bmaxvar_cat_par_wFALSE_m500_t1e-06_2021-03-30.Rdata"))
        index = 1
        b_num = out_cat$b
        cat("loading: bmaxvar_cat_par_wFALSE_m500_t1e-06_2021-03-30 \n")
        
    }

    #updated for the only bmaxvar 
    kpop_w <- weights_cat[[index]]$kpop_w
    kpop_conv_w <- weights_cat[[index]]$kpop_w_conv
    kpop_mf_w <- weights_cat[[index]]$kpop_mf_w
    #kpop_demos_w <- weights_cat[[index]]$kpop_demos_w
    #kpop_demos_wedu_w <- weights_cat[[index]]$kpop_demos_weduc_w
    #kpop_all_w <- weights_cat[[index]]$kpop_all_w
    #temproray until rerun weights
    kpop_demos_w <- weights_cat[[index]]$kpop_contraint_w
    kpop_demos_wedu_w <- weights_cat[[index]]$kpop_contraint_weduc_w
    kpop_all_w <- weights_cat[[index]]$kpop_full_constraint_w
    

    b_lab = paste0("b=", round(b_num, 2))
    if(b == "maxvar") {
        plot_b_lab = c("b=argmax var K*2")
    } else if(b == "mean") {
        plot_b_lab = c("b=mean(raw diff)")
    } else {
        plot_b_lab = c(paste0("b=",b_num))
    }

    kpop_labs = c("Kpop",
                  "Kpop Conv",
                  "Kpop aMF",
                  "Kpop+MF:\n (Demos)",
                  "Kpop+MF:\n (Demos+Edu)",
                  "Kpop+MF:\n (All)")
    # if(b == "maxvar") {
    #     kpop_labs = c("Kpop b=argmax var K*2",
    #                   "Kpop Conv b=argmax var(K)*2",
    #                   "Kpop aMF b=argmax var(K)*2",
    #                   "Kpop+MF:\n (Demos) b=argmax var(K)*2",
    #                   "Kpop+MF:\n (Demos+Edu) b=argmax var(K)*2",
    #                   "Kpop+MF:\n (All) b=argmax var(K)*2")
    # } else if(b == "mean") {
    #     kpop_labs = c("Kpop b=mean(raw diff)",
    #                   "Kpop Conv b=mean(raw diff)",
    #                   "Kpop aMF b=mean(raw diff)",
    #                   "Kpop+MF:\n (Demos) b=mean(raw diff)",
    #                   "Kpop+MF:\n (Demos+Edu) b=mean(raw diff)",
    #                   "Kpop+MF:\n (All) b=mean(raw diff)")
    # } else {
    #     kpop_labs = c(paste0("Kpop b=",b_num), 
    #                   paste0("Kpop Conv b=",b_num),
    #                   paste0("Kpop aMF b=",b_num), 
    #                   paste0("Kpop+MF:\n (Demos) b=",b_num),
    #                   paste0("Kpop+MF:\n (Demos+Edu) b=",b_num),
    #                   paste0("Kpop+MF:\n (All) b=",b_num))
    # }

    
    if(pop_weights) {
        cces_svy <- svydesign(ids = ~1, weights = ~commonweight_vv_post,
                          data = cces)
    } else {
        cces_svy <- suppressWarnings(svydesign(ids = ~1,
                          data = cces))
    }
    
     targets_rake_demos_noeduc <- create_targets(cces_svy,
                                                    formula_rake_demos_noeduc)
     targets_rake_demos_weduc <- create_targets(cces_svy, formula_rake_demos_weduc)
     targets_rake_all_vars <- create_targets(cces_svy, 
                                                       formula_rake_all_vars)
     targets_retrospective <- create_targets(cces_svy, formula_retrospective)
     targets_ps <- svytable(formula = ~strata,
                               design = subset(cces_svy, !(strata %in%
                                                                missing_strata)))
     targets_ps_reduc <- svytable(formula = ~strata_reduc,
                               design = subset(cces_svy, !(strata_reduc %in%
                                                                missing_strata_reduc)))
     targets_ps_all <- svytable(formula = ~strata_all,
                               design = subset(cces_svy, !(strata_all %in%
                                                                missing_strata_all)))
     
     rake_demos_noeduc <- calibrate(design = pew_nowt,
                                   formula = formula_rake_demos_noeduc,
                                   population = targets_rake_demos_noeduc,
                                   calfun = "raking")
     rake_demos_noeduc <- svydesign(~1, data = pew, 
                                   weights = weights(rake_demos_noeduc))
    
     rake_demos_weduc <- calibrate(design = pew_nowt,
                                  formula = formula_rake_demos_weduc,
                                  population = targets_rake_demos_weduc,
                                  calfun = "raking")
     rake_demos_weduc <- svydesign(~1, data = pew, 
                                  weights = weights(rake_demos_weduc))
    
     rake_all_vars <- calibrate(design = pew_nowt,
                                  formula = formula_rake_all_vars,
                                  population = targets_rake_all_vars,
                                  calfun = "raking")
     rake_all_vars <- svydesign(~1, data = pew, 
                                  weights = weights(rake_all_vars))
    
    #post stratification
    pew_ps <- suppressWarnings(svydesign(ids = ~1, 
                            data = pew %>% filter(!(strata %in% problem))))
    post_stratification <- postStratify(design = pew_ps,
                                        strata = ~strata,
                                        population = targets_ps)
    post_stratification <- svydesign(~1, data = pew %>% 
                                         filter(!(strata %in% problem)),
                                     weights = weights(post_stratification))
    #reduced
    pew_ps_reduc_xgb <- suppressWarnings(svydesign(ids = ~1, data = pew %>% 
                                      filter(!(strata_reduc %in% problem_reduc))))
    post_strat_reduc <- postStratify(design = pew_ps_reduc_xgb,
                                        strata = ~strata_reduc,
                                        population = targets_ps_reduc)
    post_strat_reduc <- svydesign(~1, data = pew %>%
                                      filter(!(strata_reduc %in% problem_reduc)),
                                     weights = weights(post_strat_reduc))
    
    pew_ps_all_xgb <- suppressWarnings(svydesign(ids = ~1,  data = pew %>%  
                                    filter(!(strata_all %in% problem_all))))
    post_strat_all <- postStratify(design = pew_ps_all_xgb,
                                        strata = ~strata_all,
                                        population = targets_ps_all)
    post_strat_all <- svydesign(~1, data = pew %>% 
                                    filter(!(strata_all %in% problem_all)),
                                weights = weights(post_strat_all))
    
    rake_retrospective <- calibrate(design = pew_nowt,
                                    formula = formula_retrospective,
                                    population = targets_retrospective,
                                    calfun = "raking",
                                    force = TRUE)
    rake_retrospective <- svydesign(~1,
                                    data = pew,
                                    weights = weights(rake_retrospective))
    
    # kpop
    kpop <- svydesign(~1, data = pew,
                weights = kpop_w[kbal_data_sampled ==1])

    kpop_conv <- svydesign(~1, data = pew,
                               weights = kpop_conv_w[kbal_data_sampled ==1])
    
    kpop_mf <-  svydesign(~1, data = pew,
                              weights = kpop_mf_w[kbal_data_sampled ==1])

    kpop_demos <-  svydesign(~1, data = pew,
                          weights = kpop_demos_w[kbal_data_sampled ==1])
    kpop_demos_wedu <-  svydesign(~1, data = pew,
                          weights = kpop_demos_wedu_w[kbal_data_sampled ==1])
     
    kpop_all <-  svydesign(~1, data = pew,
                          weights = kpop_all_w[kbal_data_sampled ==1])
     
    
    
    ##################################### Plot PreP
    #this will be structured to take a single choice of
    df_build <- function(var_orig, var_cces, var_pew, vote_form = vote_diff,
                         real = FALSE) {
        if(!real) {
          df <- data.frame(
            cces_orig = svycontrast(svymean(as.formula(paste0("~", var_orig)), 
                                            cces_svy, na.rm = TRUE),
                                    vote_form),
            #this is cces modeled outcome on cces
            cces_mod = svymean(as.formula(paste0("~", var_cces)), cces_svy, na.rm = TRUE),
            
            #outcome = modeled cces predicted with pew (cces on pew)
            unweighted = svymean(as.formula(paste0("~", var_pew)), pew_nowt,
                                 na.rm = TRUE),
            pew_weighted = svymean(as.formula(paste0("~", var_pew)), pew_awt, 
                                   na.rm = TRUE),
            rake_demos_noeduc = svymean(as.formula(paste0("~", var_pew)), 
                                        rake_demos_noeduc, na.rm = TRUE),
            rake_demos_weduc = svymean(as.formula(paste0("~", var_pew)), 
                                       rake_demos_weduc, na.rm = TRUE),
            rake_all_vars = svymean(as.formula(paste0("~", var_pew)), 
                                       rake_all_vars, na.rm = TRUE),
            post_stratification = svymean(as.formula(paste0("~", var_pew)), 
                                          post_stratification,
                                          na.rm = TRUE),
            post_strat_reduc = svymean(as.formula(paste0("~", var_pew)), 
                                          post_strat_reduc,
                                          na.rm = TRUE),
            post_strat_all = svymean(as.formula(paste0("~", var_pew)), 
                                          post_strat_all,
                                          na.rm = TRUE),
            rake_retrospective = svymean(as.formula(paste0("~", var_pew)),
                                         rake_retrospective, 
                                         na.rm = TRUE),
            kpop_ = svymean(as.formula(paste0("~", var_pew)), kpop, 
                                 na.rm = TRUE),
            kpop_conv = svymean(as.formula(paste0("~", var_pew)), kpop_conv,
                                      na.rm = TRUE),
            kpop_amf = svymean(as.formula(paste0("~", var_pew)), kpop_mf, 
                                    na.rm = TRUE),
            
            kpop_demos_mf =svymean(as.formula(paste0("~", var_pew)), kpop_demos,
                                  na.rm = TRUE),
            kpop_demos_wedu_mf =svymean(as.formula(paste0("~", var_pew)), 
                                       kpop_demos_wedu, na.rm = TRUE),
            kpop_all_mf = svymean(as.formula(paste0("~", var_pew)), 
                                      kpop_all, na.rm = TRUE)
            ) %>%
    pivot_longer(cols = everything(),
                         names_to = c("source", ".value"), 
                         names_pattern = "(.*)\\.(.*)") 
          
            df$SE <- coalesce(df[[var_cces]], df[[var_pew]], df$SE)
            df <- df %>% mutate(est = coalesce(nlcon, mean))
        } else {
            df <- data.frame(
                cces_orig = svycontrast(svymean(~recode_vote_2016, 
                                                cces_svy, na.rm = TRUE),
                                        vote_form),
                #outcome = modeled cces predicted with pew (cces on pew)
                unweighted = svycontrast(svymean(~recode_vote_2016, 
                                                 pew_nowt, na.rm = TRUE),
                                         vote_form),
                pew_weighted = svycontrast(svymean(~recode_vote_2016, 
                                                   pew_awt, na.rm = TRUE),
                                           vote_form),
                
                rake_demos_noeduc = svycontrast(svymean(~recode_vote_2016, 
                                                        rake_demos_noeduc, na.rm = TRUE),
                                                vote_form),
                rake_demos_weduc = svycontrast(svymean(~recode_vote_2016, 
                                                       rake_demos_weduc, na.rm = TRUE),
                                               vote_form),
                rake_all_vars = svycontrast(svymean(~recode_vote_2016, 
                                                       rake_all_vars, na.rm = TRUE),
                                               vote_form),
                post_stratification = svycontrast(svymean(~recode_vote_2016, 
                                                          post_stratification,
                                                          na.rm = TRUE),
                                                  vote_form),
                post_strat_reduc = svycontrast(svymean(~recode_vote_2016, 
                                                          post_strat_reduc,
                                                          na.rm = TRUE),
                                                  vote_form),
                post_strat_all = svycontrast(svymean(~recode_vote_2016, 
                                                          post_strat_all,
                                                          na.rm = TRUE),
                                                  vote_form),
                rake_retrospective = svycontrast(svymean(~recode_vote_2016, 
                                                         rake_retrospective,
                                                         na.rm = TRUE),
                                                 vote_form),
            
                kpop= svycontrast(svymean(~recode_vote_2016,
                                                  kpop, na.rm = TRUE), vote_form),
                kpop_conv =svycontrast(svymean(~recode_vote_2016,
                                                  kpop_conv, na.rm = TRUE), vote_form),
                kpop_amf = svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf, na.rm = TRUE), vote_form),
                
                kpop_demos_mf = svycontrast(svymean(~recode_vote_2016,
                                                  kpop_demos, na.rm = TRUE), vote_form),
                kpop_demos_wedu_mf = svycontrast(svymean(~recode_vote_2016,
                                                  kpop_demos_wedu, na.rm = TRUE), vote_form),
                kpop_all_mf = svycontrast(svymean(~recode_vote_2016,
                                                  kpop_all, na.rm = TRUE), vote_form)
        ) %>%
                pivot_longer(cols = everything(),
                             names_to = c("source", ".value"), 
                             names_pattern = "(.*)\\.(.*)") 
            
            df <- df %>% rename(est = nlcon)
            
        }
        #df <- df %>% filter(!is.na(source))
        df <- df %>% 
            dplyr::select(source, est, SE) %>%
            mutate(est = est * 100,
                   SE = SE * 100,
                   #err_target = est - target_diff * 100,
                   source = str_replace(source, "_", " "))
        
        df$b <- NA
        df$b[grep("kpop", df$source) ]<- b
        df$MF <- "NA"
        df$MF[grep("mf", df$source) & !grep("amf", df$source)] <- "MF"
        df$MF[!grepl("mf", df$source) & grepl("kpop", df$source)]<- "No MF"
        df$aMF <- "NA"
        df$aMF[grep("amf", df$source)] <- "aMF"
        df$aMF[!grepl("amf", df$source) & grepl("kpop", df$source)]<- "No aMF"
        
        df$Conv <- "NA"
        df$Conv[!grepl("conv", df$source) & 
                              grepl("kpop", df$source)]<- "Conv Not Required"
        df$Conv[c(grep("conv", df$source),
                            grep("mf", df$source))] <- "Conv Required"
        df <- df %>% arrange(!is.na(b), b)
        df <- df %>% 
            mutate(source_name = factor(source, 
                                        levels = as.character(df$source) ,
                                        labels = c("CCES Orig",
                                                   if(!real){"CCES Modeled"},
                                                   "Pew Unweighted", 
                                                   "Pew Weights",
                                                   "Mean Calibration:\n (Demos)", 
                                                   "Mean Calibration:\n (Demos+Edu)", 
                                                   "Mean Calibration:\n (All)",
                                                   "Post-Strat (former)", 
                                                   "Post-Stratification:\n (Reduc)",
                                                   "Post-Strat (All)",
                                                   "Mean Calibration:\n (Retrospective)", 
                                                  c(kpop_labs)
                                            )))
        df <- df %>% filter(!is.na(est))
        
        return(df)
    }
    
    comp_df_diff <- df_build("recode_vote_2016", "diff_cces_on_cces", "diff_cces_on_pew")
    
    # comp_df_diff_pewoutcome <- df_build("recode_vote_2016", 
    #                                     "diff_pew_on_cces",
    #                                     "diff_pew_on_pew") 
    # 
    comp_df_margin <- df_build("recode_vote_2016", 
                               "margin_cces_on_cces",
                               "margin_cces_on_pew")  
  
    
    # comp_df_margin_pewoutcome <- df_build("recode_vote_2016", 
    #                                       "margin_pew_on_cces",
    #                                       "margin_pew_on_pew")  
    
    comp_df_pR <- df_build("recode_vote_2016", 
                           "mod_cces_on_cces_pR",
                           "mod_cces_on_pew_pR",
                            vote_form = quote((recode_vote_2016Republican  +recode_vote_2016Republican)/2 ))  
    
    # comp_df_pR_pewoutcome <- df_build("recode_vote_2016", 
    #                        "mod_pew_on_cces_pR",
    #                        "mod_pew_on_pew_pR",
    #                        vote_form = quote((recode_vote_2016Republican  +recode_vote_2016Republican)/2 )) 
   
    
    comp_df_pD <- df_build("recode_vote_2016", 
                           "mod_cces_on_cces_pD",
                           "mod_cces_on_pew_pD",
                           vote_form = quote((recode_vote_2016Democrat +recode_vote_2016Democrat)/2 )) 
   
        
    # comp_df_pD_pewoutcome <- df_build("recode_vote_2016", 
    #                        "mod_pew_on_cces_pD",
    #                        "mod_pew_on_pew_pD", 
    #                        vote_form = quote((recode_vote_2016Democrat +recode_vote_2016Democrat)/2 ))  
    
    
    comp_df_real <- df_build("recode_vote_2016", 
                           "recode_vote_2016",
                           "recode_vote_2016",
                           real = TRUE, 
                           vote_form = vote_contrast)
    
    
    comp_df_real_diff <-  df_build("recode_vote_2016", 
                           "recode_vote_2016",
                           "recode_vote_2016",
                           real = TRUE) 
    
    
    if(is.null(specify_nonkpop)) {
        select_nonkpop <- c("CCES Orig", "CCES Modeled",
                                "Pew Unweighted", 
                                "Mean Calibration:\n (Demos)", 
                                "Mean Calibration:\n (Demos+Edu)", 
                                "Mean Calibration:\n (All)",
                                "Mean Calibration:\n (Retrospective)",
                                "Post-Stratification:\n (Reduc)")
    }
    if(is.null(specify_kpop)) {
        select_kpop <- kpop_labs[!grepl("aMF", kpop_labs) & !grepl("Conv", kpop_labs)]
    }
   comp_df_diff <- comp_df_diff %>% 
       filter(source_name %in% select_nonkpop | source_name %in% select_kpop)
    # comp_df_diff_pewoutcome <- comp_df_diff_pewoutcome %>% 
    #     filter(source_name %in% select_nonkpop | source_name %in% select_kpop)
    
    comp_df_margin <- comp_df_margin %>% 
        filter(source_name %in% select_nonkpop | source_name %in% select_kpop)
    # comp_df_margin_pewoutcome <- comp_df_margin_pewoutcome %>% 
    #     filter(source_name %in% select_nonkpop | source_name %in% select_kpop)
    
    comp_df_pR <- comp_df_pR %>% 
        filter(source_name %in% select_nonkpop | source_name %in% select_kpop)
    # comp_df_pR_pewoutcome <- comp_df_pR_pewoutcome %>%
    #     filter(source_name %in% select_nonkpop | source_name %in% select_kpop)
    
     comp_df_pD <- comp_df_pD %>% 
        filter(source_name %in% select_nonkpop | source_name %in% select_kpop)
    # comp_df_pD_pewoutcome <- comp_df_pD_pewoutcome %>%
    #     filter(source_name %in% select_nonkpop | source_name %in% select_kpop)
    
    comp_df_real <- comp_df_real %>% 
        filter(source_name %in% select_nonkpop | source_name %in% select_kpop)
    comp_df_real_diff <- comp_df_real_diff %>%
        filter(source_name %in% select_nonkpop | source_name %in% select_kpop)

    
    pew_ver = "Pre-Wave"
 
    if(pop_weights) {
        popw_lab = "(w/Pop Weights)"
        mod_lab = "Lasso Modeled"
    } else {
        popw_lab = "(No Pop Weights)"
        mod_lab = "XGB Modeled"
    }
    
    
    pres <- readRDS(paste0(path_data, "election.rds"))
    
    natl_margin <- pres %>%
        summarise(margin = (sum(demtotal) - sum(reptotal)) /
                      (sum(demtotal) + sum(reptotal))) %>%
        as.numeric()
    
    natl_diff <- pres %>%
        summarise(margin = (sum(demtotal) - sum(reptotal)) /
                      (sum(totalvotes))) %>%
        as.numeric()

    natl_Rep <- pres %>%
        summarise(pR =  sum(reptotal) /
                      sum(totalvotes)) %>%
        as.numeric()
    natl_Dem <- pres %>%
        summarise(pR =  sum(demtotal) /
                      sum(totalvotes)) %>%
        as.numeric()
    
    
    
    ############plots
    comp_df_real_margin_plot <- comp_df_real %>% filter(!str_detect(source, "cces"))
    comp_df_plot_real_margin <-
        ggplot() +
        aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE) +
        
        geom_hline(yintercept = c(0, if(pop_weights) {natl_margin*100},
                                  comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"]),
                   linetype = c("solid", if(pop_weights) {"dashed"}, "longdash"),
                   color = c("black", if(pop_weights){"gray60"}, "black")) +
        geom_pointrange(data = comp_df_real_margin_plot) +
        scale_y_continuous(breaks = c(natl_margin, seq(-5, 10, 5)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        
        labs(x = NULL, y = "Estimated Vote Margin (95% CI)", popw_lab) +
        ggtitle(paste(pew_ver, " Pew on TRUE CCES Vote Margin", popw_lab, plot_b_lab)) +
        theme(axis.text.x = element_text(angle = 70, hjust = 1 )) +
        annotate(geom = "text", x = nrow(comp_df_real_margin_plot)+.35,
                 y = if(pop_weights){natl_margin * 100} else {comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"] },
                 label = if(pop_weights) {" True\n National\n Margin"} else {""},
                 hjust = 0, angle = -90,
                 color = "gray60", size = 3) +
        annotate(geom = "text", x = nrow(comp_df_real_margin_plot)+.35,
                 y = comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"],
                 label = if(pop_weights)" Weighted\n CCES\n Target" else {" Unweighted\n CCES\n Target"},
                 hjust = 0, angle = 90, size = 3) +
        #for spacing
         annotate(geom = "text", x = nrow(comp_df_real_margin_plot)+1,
                 y = comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"],
                 label = " ",
                 hjust = 0, angle = 90, size = 3) +
        theme(legend.title = element_blank())
    
    comp_df_real_diff_plot <- comp_df_real_diff %>% filter(!str_detect(source, "cces"))
    comp_df_plot_real_diff <-
        ggplot() +
        aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE)  + 
        
        geom_hline(yintercept = c(0, if(pop_weights){natl_diff*100},
                                  comp_df_real_diff$est[comp_df_real_diff$source_name
                                                        =="CCES Orig"]),
                   linetype = c("solid", if(pop_weights){"dashed"}, "longdash"),
                   color = c("black", if(pop_weights) {"gray60"}, "black")) +
        geom_pointrange(data = comp_df_real_diff_plot) +
        scale_y_continuous(breaks = c(natl_diff*100, seq(-5, 10, 5)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        
        labs(x = NULL, y = "Estimated Vote Difference (95% CI)") +
        ggtitle(paste(pew_ver, " Pew on TRUE CCES Vote Difference",  
                      popw_lab, plot_b_lab)) +
        theme(axis.text.x = element_text(angle = 70, hjust = 1)) +
        annotate(geom = "text", 
                 x = nrow(comp_df_real_diff_plot) +.35,
                 y = if(pop_weights) {natl_diff * 100} else {comp_df_real_diff$est[comp_df_real_diff$source_name == 
                                               "CCES\ Orig"]},
                 label = if(pop_weights){" True\n National\n Diff"} else {""},
                 hjust = 0, angle = -90,
                 color = "gray60", size = 3) +
        annotate(geom = "text", x = nrow(comp_df_real_diff_plot) +.35,
                 y = comp_df_real_diff$est[comp_df_real_diff$source_name == 
                                               "CCES\ Orig"],
                 label = if(pop_weights)" Weighted\n CCES\n Target" else {" Unweighted\n CCES\n Target"},
                 hjust = 0, angle = 90, size = 3) +
        #for spacing
         annotate(geom = "text", x = nrow(comp_df_real_diff_plot) +1,
                 y = comp_df_real_diff$est[comp_df_real_diff$source_name == 
                                               "CCES Orig"],
                 label = "",
                 hjust = 0, angle = 90, size = 3) +
        theme(legend.title = element_blank())
    
    
    ######### main vote diff plot #########
    comp_df_diff_plot <- comp_df_diff %>% filter(!str_detect(source, "cces")) %>% 
    mutate(method =  factor(case_when(str_detect(source, "unweighted") ~ "Raw Survey", 
                               str_detect(source, "rake") ~ "Mean Calibration",
                               str_detect(source, "post") ~ "Post-Strat",
                               str_detect(source, "kpop") ~ "Kpop", 
                               TRUE ~ NA_character_),
                            levels = c("Raw Survey", "Mean Calibration", "Post-Strat", "Kpop")),
           zero = 0,
           natl_diff =natl_diff*100,
           cces_target = comp_df_diff$est[comp_df_diff$source_name == "CCES Modeled"])

    text_for_gg <- data.frame(source_name =  c(4.50, 4.50, 5),
                          method =factor("Kpop", levels(comp_df_diff_plot$method)),
                          est = c(comp_df_diff_plot$natl_diff[1], 
                                  comp_df_diff_plot$cces_target[1], 0),
                          label = c(" True\n National\n Diff", 
                                    " Weighted\n CCES\n Target", " "))


    comp_df_plot_diff <- ggplot(comp_df_diff_plot) +
        geom_pointrange(aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE)) +
        facet_grid(cols = vars(method),  scales = "free_x", space = "free_x") +
        geom_hline(aes(yintercept = zero)) +
        geom_hline(aes(yintercept = natl_diff), linetype = 2, color = "grey60") +
        geom_hline(aes(yintercept = cces_target), linetype = 2) +
       
        scale_y_continuous(breaks = c(natl_diff*100, seq(-5, 10, 5)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        labs(x = NULL, y = "Estimated Modeled Vote Difference (95% CI)") +
        theme(axis.text.x = element_text(angle = 70, hjust = 1)) +
        geom_text(data = text_for_gg, aes(x = source_name, 
                                          y = est,
                                          label = label), 
                  angle = c(-90,90, 90), color = c("grey60", "black", "purple"),
                  hjust = 0, size = 2.6) +
        theme()
    # 
    # comp_df_plot_diff <-
    #     ggplot(comp_df_diff_plot) +
    #     aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE) +
    #     geom_hline(yintercept = c(0, 
    #                               if(pop_weights) {natl_diff*100},
    #                              #if(pop_weights) {comp_df_diff$est[comp_df_diff$source_name == "CCES Orig"]},
    #                               comp_df_diff$est[comp_df_diff$source_name == "CCES Modeled"]),
    #                linetype = c("solid", 
    #                             if(pop_weights) {"dashed"}, 
    #                             #if(pop_weights) {"longdash"},
    #                             "dashed"),
    #                color = c("black", 
    #                          if(pop_weights) {"gray60"}, 
    #                          #if(pop_weights) {"black"},
    #                          "black")) +
    #     
    #     geom_pointrange() +
    #     scale_y_continuous(breaks = c(natl_diff*100, seq(-5, 10, 5)),
    #                        minor_breaks = NULL,
    #                        labels = scales::percent_format(scale=1, accuracy = 0.1)) +
    #     theme_bw() +
    #     theme(plot.title = element_text(hjust = 0.5)) +
    #     
    #     labs(x = NULL, y = "Estimated Modeled Vote Difference (95% CI)") +
    #     # ggtitle(paste(pew_ver, "Pew on CCES",mod_lab,"Mean Indiv Vote Diff p(D) - p(R)",
    #     #               popw_lab, plot_b_lab)) +
    #     theme(axis.text.x = element_text(angle = 70, hjust = 1)) +
    #     annotate(geom = "text", 
    #              x =nrow(comp_df_diff_plot)+.35, 
    #              y = if(pop_weights) {natl_diff * 100} else {comp_df_diff$est[comp_df_diff$source_name == "CCES Modeled"]},
    #              label = if(pop_weights) {" True\n National\n Diff"} else {""},
    #              hjust = 0, angle = -90,
    #              color = "gray60", size = 3) +
    #     annotate(geom = "text",
    #              x = nrow(comp_df_diff_plot)+.35,
    #              y = comp_df_diff$est[comp_df_diff$source_name == "CCES Modeled"],
    #              label = " CCES\n Modeled Target",
    #              color = "black",
    #              hjust = 0, angle = 90, size = 3) +
    #     # annotate(geom = "text", 
    #     #          x = nrow(comp_df_pR)+1, 
    #     #          y = if(pop_weights) {comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"]} else { comp_df_diff$est[comp_df_diff$source_name == "CCES Modeled"]},
    #     #          label = if(pop_weights){" Weighted\n CCES\n Target"} else {""},
    #     #          color = "black",
    #     #          hjust = 0, angle = -90, size = 3) +
    #     #for spacing
    #     annotate(geom = "text", 
    #              x = nrow(comp_df_diff_plot)+1,
    #              y = comp_df_diff$est[comp_df_diff$source_name == "CCES Modeled"],
    #              label = "",
    #              color = "purple",
    #              hjust = 0, angle = -90, size = 3) +
    #     
    #     theme(legend.title = element_blank())
    # 

    
    comp_df_margin_plot <- comp_df_margin %>% filter(!str_detect(source, "cces")) 
    comp_df_plot_margin <-
        ggplot() +
        aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE) +
        geom_hline(yintercept = c(0, 
                                  if(pop_weights) {natl_margin*100},
                                 # if(pop_weights) {comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"]},
                                  comp_df_margin$est[comp_df_margin$source_name == "CCES Modeled"]),
                   linetype = c("solid", 
                                if(pop_weights) {"dashed"},
                                #if(pop_weights) {"longdash"},
                                "dashed"),
                   color = c("black", 
                             if(pop_weights) {"gray60"},
                             #if(pop_weights){"black"},
                             "black")) +
        geom_pointrange(data =  comp_df_margin_plot) +
        scale_y_continuous(breaks = c(natl_margin, seq(-5, 10, 5)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        
        labs(x = NULL, y = "Estimated Modeled Vote Margin (95% CI)") +
        ggtitle(paste(pew_ver, "Pew on CCES", mod_lab, "Mean Indiv Vote Margin",popw_lab,
                      plot_b_lab)) +
        theme(axis.text.x = element_text(angle = 70, hjust = 1)) +
         annotate(geom = "text", 
                  x = nrow(comp_df_margin_plot)+.35, 
                 y = if(pop_weights) {natl_margin * 100} else {comp_df_margin$est[comp_df_margin$source_name == "CCES Modeled"]},
                 label = if(pop_weights) {" True\n National\n Margin"} else {""},
                 hjust = 0, angle = -90,
                 color = "gray60", size = 3) +
        annotate(geom = "text", 
                 x =  nrow(comp_df_margin_plot)+.35,
                 y = comp_df_margin$est[comp_df_margin$source_name == "CCES Modeled"],
                 label = " CCES\n Modeled Target",
                 color = "black",
                 hjust = 0, angle = 90, size = 3) +
        # annotate(geom = "text", 
        #          x = nrow(comp_df_pR)+1,
        #          y = if(pop_weights) {comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"]} else {comp_df_margin$est[comp_df_margin$source_name == "CCES Modeled"]}, 
        #          label = if(pop_weights) {" Weighted\n CCES\n Target"} else {""},
        #          color = "black",
        #          hjust = 0, angle = -90, size = 3) +
        #for spacing
        annotate(geom = "text",
                 x = nrow(comp_df_margin_plot)+1,
                 y = comp_df_margin$est[comp_df_margin$source_name == "CCES Modeled"],
                 label = "",
                 color = "purple",
                 hjust = 0, angle = -90, size = 3) +
        
        theme(legend.title = element_blank())
    
    
    ####### p(R) plot
    comp_df_pR_plot <- comp_df_pR %>% filter(!str_detect(source, "cces")) 
    comp_df_plot_both_pR <-
        ggplot() +
        aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE) +
        
        geom_hline(yintercept = c(if(pop_weights) {natl_Rep*100},
                                  # if(pop_weights) {comp_df_pR$est[comp_df_pR$source_name == "CCES Orig"]},
                                  comp_df_pR$est[comp_df_pR$source_name == "CCES Modeled"]),
                   linetype = c( if(pop_weights) {"dashed"}, 
                                 #if(pop_weights){"longdash"}, 
                                 "dashed"),
                   color = c(if(pop_weights) {"gray60"},
                             #if(pop_weights) {"black"},
                             "black")) +
        geom_pointrange(data = comp_df_pR_plot) +
       # geom_pointrange(data = comp_df_pR_pewoutcome, alpha = 0.4) +
        scale_y_continuous(breaks = c(natl_Rep, seq(40, 48, 2)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        
        labs(x = NULL, y = "Estimated Modeled Vote p(R) (95% CI)") +
        ggtitle(paste(pew_ver,"Pew on CCES", mod_lab,  "p(R) modeled",
                     popw_lab, plot_b_lab)) +
        theme(axis.text.x = element_text(angle = 70, hjust = 1)) +
        annotate(geom = "text", 
                 x = nrow(comp_df_pR_plot)+.35, 
                 y = if(pop_weights) {natl_Rep * 100} else {comp_df_pR$est[comp_df_pR$source_name == "CCES Modeled"]},
                 label = if(pop_weights) {" True\n National\n % Rep"} else {""},
                 hjust = 0, angle = +90,
                 color = "gray60", size = 3) +
        # annotate(geom = "text",
        #          x = nrow(comp_df_pR)+1,
        #          y = if(pop_weights) {comp_df_pR$est[comp_df_pR$source_name == "CCES Orig"]} else {comp_df_pR$est[comp_df_pR$source_name == "CCES Modeled"]},
        #          label = if(pop_weights) {" Weighted\n CCES\n Target"} else {""},
        #          hjust = 0, angle = -90, size = 3) +
        annotate(geom = "text",
                 x = nrow(comp_df_pR_plot)+.35,
                 y = comp_df_pR$est[comp_df_pR$source_name == "CCES Modeled"],
                 label = " CCES\n Modeled Target",
                 color = "black",
                 hjust = 0, angle = -90, size = 3) +
        #for spacing
        annotate(geom = "text", 
                 x = nrow(comp_df_pR_plot)+1,
                 y = comp_df_pR$est[comp_df_pR$source_name == "CCES Modeled"],
                 label = "",
                 color = "purple",
                 hjust = 0, angle = -90, size = 3) +
        theme(legend.title = element_blank())
    
    
    
    ###### p(D) plot
    comp_df_pD_plot <- comp_df_pD %>% filter(!str_detect(source, "cces")) 
    
    comp_df_plot_both_pD <-
        ggplot() +
        aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE) +
        
        geom_hline(yintercept = c(if(pop_weights) {natl_Dem*100},
                                  #if(pop_weights) {comp_df_pD$est[comp_df_pD$source_name == "CCES Orig"]},
                                  comp_df_pD$est[comp_df_pD$source_name == "CCES Modeled"]),
                   linetype = c( if(pop_weights) {"dashed"}, 
                                 #if(pop_weights){"longdash"}, 
                                 "dashed"),
                   color = c(if(pop_weights) {"gray60"},
                             #if(pop_weights) {"black"},
                             "black")) +
        geom_pointrange(data = comp_df_pD_plot ) +
        scale_y_continuous(breaks = c(natl_Dem*100, seq(40, 56, 4)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        
        labs(x = NULL, y = "Estimated Modeled Vote p(R) (95% CI)") +
        ggtitle(paste(pew_ver, "Pew on CCES", mod_lab, "p(D) modeled",
                      popw_lab, plot_b_lab)) +
        theme(axis.text.x = element_text(angle = 70, hjust = 1)) +
        annotate(geom = "text", 
                 x = nrow(comp_df_pD_plot)+.35,
                 y = if(pop_weights) {natl_Dem * 100} else {comp_df_pD$est[comp_df_pD$source_name == "CCES Orig"]},
                 label = if(pop_weights){" True\n National\n % Rep"} else {""},
                 hjust = 0, angle = -90,
                 color = "gray60", size = 3) +
        # annotate(geom = "text", 
        #          x =nrow(comp_df_pR)+1,
        #          y = if(pop_weights) {comp_df_pD$est[comp_df_pD$source_name == "CCES Orig"]} else { comp_df_pD$est[comp_df_pD$source_name == "CCES Modeled"]},
        #          label = if(pop_weights) {" Weighted\n CCES\n Target"} else {""},
        #          hjust = 0, angle = 90, size = 3) +
        annotate(geom = "text", 
                 x = nrow(comp_df_pD_plot)+.35,
                 y = comp_df_pD$est[comp_df_pD$source_name == "CCES Modeled"],
                 label = " CCES\n Modeled Target",
                 color = "black",
                 hjust = 0, angle = 90, size = 3) +
        annotate(geom = "text",
                 x = nrow(comp_df_pD_plot)+1,
                 y = comp_df_pD$est[comp_df_pD$source_name == "CCES Modeled"],
                 label = "",
                 color = "purple",
                 hjust = 0, angle = 90, size = 3) +
        theme(legend.title = element_blank() )
    
    
    CIs_diff <- comp_df_diff %>% mutate(CI_low = est - qnorm(.975)*SE, 
                                             CI_high = est+ qnorm(.975)*SE, 
                                             CI_width = CI_high - CI_low) %>% 
    dplyr::select(source, est, SE, CI_low, CI_high, CI_width)
    
    kable_diff <- kable(CIs_diff %>% dplyr::select(-CI_width), 
                        format = "latex", 
                        booktabs = T,
                        caption = "Performance on the Outcome among Various Weighting Methods",
                        digits = 2)
    
    out <- list(plot_diff = comp_df_plot_diff,
                plot_margin = comp_df_plot_margin,
                plot_pR = comp_df_plot_both_pR,
                plot_pD = comp_df_plot_both_pD,
                plot_real_margin = comp_df_plot_real_margin,
                plot_real_diff = comp_df_plot_real_diff,
                problem = problem,
                problem_reduc = problem_reduc,
                problem_all = problem_all,
                comp_df_diff = comp_df_diff,
                comp_df_margin = comp_df_margin,
                comp_df_pR = comp_df_pR,
                comp_df_pD = comp_df_pD, 
                comp_df_real_margin = comp_df_real,
                comp_df_real_diff = comp_df_real_diff, 
                kable_diff = kable_diff,
                CIs_diff = CIs_diff)
    return(out)
}




```




```{r run_res_main}

clean_results <- main_res_plot()
clean_results$CIs_diff
clean_results$kable_diff

#these SEs are roughly proportional to var(w)
load(paste0(path_weights,"bmaxvar_cat_par_wTRUE_m500_t1e-06_2021-03-30.Rdata"))
var(weights_cat[[1]]$kpop_w[1:nrow(pew)])
var(weights_cat[[1]]$kpop_contraint_w[1:nrow(pew)])
var(weights_cat[[1]]$kpop_contraint_weduc_w[1:nrow(pew)])
var(weights_cat[[1]]$kpop_full_constraint_w[1:nrow(pew)])

var(weights(rake_demos_noeduc)/mean(weights(rake_demos_noeduc)))
var(weights(rake_demos_weduc)/mean(weights(rake_demos_weduc)))

clean_results$plot_diff
clean_results$plot_margin
ggsave("/Users/Ciara/Dropbox/kpop/Updated/application/plots/bmaxvar_votediff_facet.pdf", width = 8, height = 6)
clean_results$plot_pR
clean_results$plot_pD
clean_results$plot_real_margin

```










## Plots over Range of b

This formula produces the monster plots across a range of choices of b for pR, pD, vote difference, and vote margin. This currently does not plot Kpop + (demos)/(demos w edu)/(all) etc. For those plots there's a simplified version below.

```{r plot_funct}
#bigB = T means plot b's in range 128-2048
#smallB = T means plot b's in range 2-64
#display_pew_mod = T will plot the the same results for the modeled pew outcomes additionally to compare and observe bias in response
#maxit and toelrance should remain at defaults for now
#indiv_b allows you to pass in a number or "maxvar" or "mean" to plot only that b
#clean nonkpop drops plotting pew weighted, post strat former, and post strat all
#specify_nonkpop allows you to pass in a character vector of the source_name of the non kpop methods oyu want to display default is as described above

pew_out <- function(popw = TRUE,
                    best_b_plot = FALSE, 
                    bigB = TRUE, 
                    smallB = TRUE,
                    indiv_b = NULL,
                    clean_nonkpop = TRUE, 
                    specify_nonkpop = NULL,
                    display_pew_mod = FALSE, 
                    tolerance = 1e-06, 
                    maxit = 500) {
   
    
    #this subsets cces strata to only those in pew
    missing_strata <- unique(cces$strata)[!(unique(cces$strata) %in%
                                                unique(pew$strata))]
    cat(length(missing_strata)/ length(unique(cces$strata)), 
        "% cces original strata missing from pew, ",
        "\nand", cces %>% filter(strata %in% missing_strata) %>% summarise(n()) %>% pull(), "/", nrow(cces), "units\n" )
    cces %>% filter(strata %in% missing_strata) %>% summarise(n())
  
    missing_strata_reduc <- unique(cces$strata_reduc)[!(unique(cces$strata_reduc) %in%
                                                unique(pew$strata_reduc))]
    
     cat(length(missing_strata_reduc)/ length( unique(cces$strata_reduc)), 
         "% cces reduc strata missing from pew, ",
        "\nand", cces %>% filter(strata_reduc %in% missing_strata_reduc) %>% summarise(n()) %>% pull(), "/", nrow(cces), "units\n" )
     
    missing_strata_all <- unique(cces$strata_all)[!(unique(cces$strata_all) %in%
                                                unique(pew$strata_all))]
     cat(length(missing_strata_all)/ length( unique(cces$strata_all)),
         "% cces all strata missing from pew, ",
         "\nand", cces %>% filter(strata_all %in% missing_strata_all) %>% summarise(n()) %>% pull(), "/", nrow(cces), "units\n")
    
    #we also have the reverse where pew may have strata we don't have in cces
    #this arises if we eliminate NAs in recode_vote for cces
    #this ofc would never happen if cces was a true full pop but it's actually just
    #a much bigger sample so it can happen
     problem <- unique(pew$strata)[!(unique(pew$strata) %in%
                                                   unique(cces$strata))]
     problem_reduc <- unique(pew$strata_reduc)[!(unique(pew$strata_reduc) %in%
                                                   unique(cces$strata_reduc))]
     length(problem_reduc)
     problem_all <- unique(pew$strata_all)[!(unique(pew$strata_all) %in%
                                                   unique(cces$strata_all))]
     length(problem_all)
     if(length(problem) != 0) {
     warning(paste("NB: strata present in pew not in cces (3way)will be dropped in ps:\n",
                   problem, 
                   "\nrepresenting", nrow(pew %>% filter(strata %in% problem)),
                   "/", nrow(pew), "\n"), immediate. = F)
     }
     if(length(problem_reduc) != 0) {
     warning(paste("NB: strata reduc present in pew not in cces (3way)will be dropped in ps:\n",
                   "\nrepresenting", nrow(pew %>% filter(strata_reduc %in%
                                                             problem_reduc)),
                   "/", nrow(pew), "\n"), immediate. = F)
     }
     if(length(problem_all) != 0) {
     warning(paste("NB: strata all present in pew not in cces (3way)will be dropped in ps:\n",
                   "\nrepresenting", nrow(pew %>% filter(strata_all %in% problem_all)),
                   "/", nrow(pew), "\n"), immediate. = F)
     }
    

   
    pew_srs <- suppressWarnings(svydesign(ids = ~1, data = pew))
    pew_w_srs <-  svydesign(ids = ~1, weights = ~weight, data = pew)

    if(popw) {
        
       if(tolerance == 1e-06 & maxit == 500) { 
           
            load(paste0(path_weights, "/allB_cat_par_wTRUE_m500_t1e-06_2021-03-18.Rdata"))
            cat("loading: allB_cat_par_wTRUE_m500_t1e-06_2021-03-18.Rdata")
                clean <- out_cat
                weights <- weights_cat[3:13]
                weights_alt <- weights_cat[1:2]
       }
      if(maxit == 800 & tolerance == 1e-04) {
            load(paste0(path_weights,"allB_cat_par_wTRUE_m800_t1e-04_2021-03-23.Rdata"))
            cat("loading: allB_cat_par_wTRUE_m800_t1e-04_2021-03-23.Rdata")
            clean <- out_cat
            weights <- weights_cat[3:13]
            weights_alt <- weights_cat[1:2]
        }
        
        
    } else { #no pop weights
    
        if(maxit == 500 & tolerance == 1e-06) {
            load(paste0(path_weights, "weights/allB_cat_par_m500_t1e-06_2021-03-04.Rdata"))
            cat("OLD MF loading: allB_cat_par_m500_t1e-06_2021-03-18.Rdata")
            warning("OLD MF RESULTS")
        }
       
            weights <- weights_cat[3:13]
            weights_alt <- weights_cat[1:2]
            clean <- out_cat
    }  
    
    ############## PREP FOR PLOT
    ###### Kbal
    kbal_data_sampled <- c(rep(1, nrow(pew)), rep(0, nrow(cces)))
    

     kpop_bmean <- svydesign(~1, data = pew, 
                                  weights =
                                 weights_alt[[1]]$kpop_w[kbal_data_sampled==1])
     kpop_bmean_conv <- svydesign(~1, data = pew, 
                               weights = 
                                   weights_alt[[1]]$kpop_w_conv[kbal_data_sampled==1])
     kpop_mf_bmean <- svydesign(~1, data = pew, 
                             weights =
                                 weights_alt[[1]]$kpop_mf_w[kbal_data_sampled==1])
    
     kpop_bmaxvar <- svydesign(~1, data = pew, 
                                  weights =
                                 weights_alt[[2]]$kpop_w[kbal_data_sampled==1])
     kpop_bmaxvar_conv <- svydesign(~1, data = pew, 
                               weights = 
                                   weights_alt[[2]]$kpop_w_conv[kbal_data_sampled==1])
     kpop_mf_bmaxvar <- svydesign(~1, data = pew, 
                             weights =
                                 weights_alt[[2]]$kpop_mf_w[kbal_data_sampled==1])
         
        
    if(bigB) {
            
            kpop_b128 <- svydesign(~1, data = pew, 
                                      weights = weights[[7]]$kpop_w[kbal_data_sampled==1])
            kpop_b128_conv <- svydesign(~1, data = pew, 
                                   weights = 
                                       weights[[7]]$kpop_w_conv[kbal_data_sampled==1])
            kpop_mf_b128 <- svydesign(~1, data = pew, 
                                 weights =
                                     weights[[7]]$kpop_mf_w[kbal_data_sampled==1])
            
            kpop_b256 <- svydesign(~1, data = pew, 
                              weights = weights[[8]]$kpop_w[kbal_data_sampled==1])
            kpop_b256_conv <- svydesign(~1, data = pew, 
                                   weights = 
                                       weights[[8]]$kpop_w_conv[kbal_data_sampled==1])
            kpop_mf_b256 <- svydesign(~1, data = pew, 
                                 weights =
                                     weights[[8]]$kpop_mf_w[kbal_data_sampled==1])
            
            kpop_b512 <- svydesign(~1, data = pew, 
                              weights = weights[[9]]$kpop_w[kbal_data_sampled==1])
            kpop_b512_conv <- svydesign(~1, data = pew, 
                                   weights =
                                weights[[9]]$kpop_w_conv[kbal_data_sampled==1])
            kpop_mf_b512 <- svydesign(~1, data = pew, 
                                 weights =
                                     weights[[9]]$kpop_mf_w[kbal_data_sampled==1])
            
            kpop_b1024 <- svydesign(~1, data = pew, 
                              weights = weights[[10]]$kpop_w[kbal_data_sampled==1])
            kpop_b1024_conv <- svydesign(~1, data = pew, 
                        weights = weights[[10]]$kpop_w_conv[kbal_data_sampled==1])
            kpop_mf_b1024 <- svydesign(~1, data = pew, 
                                 weights =
                                     weights[[10]]$kpop_mf_w[kbal_data_sampled==1])
            
            kpop_b2048 <- svydesign(~1, data = pew, 
                              weights = weights[[11]]$kpop_w[kbal_data_sampled==1])
            kpop_b2048_conv <- svydesign(~1, data = pew, 
                                   weights = 
                            weights[[11]]$kpop_w_conv[kbal_data_sampled==1])
            kpop_mf_b2048 <- svydesign(~1, data = pew, 
                                 weights =
                                     weights[[11]]$kpop_mf_w[kbal_data_sampled==1])
            
                    
          
        }
     
    if(smallB) {
             kpop_b64 <- svydesign(~1, data = pew, 
                              weights = weights[[6]]$kpop_w[kbal_data_sampled==1])
            kpop_b64_conv <- svydesign(~1, data = pew, 
                                   weights = 
                                       weights[[6]]$kpop_w_conv[kbal_data_sampled==1])
            kpop_mf_b64 <- svydesign(~1, data = pew, 
                                 weights =
                                     weights[[6]]$kpop_mf_w[kbal_data_sampled==1])
            
             kpop_b32 <- svydesign(~1, data = pew, 
                                  weights = weights[[5]]$kpop_w[kbal_data_sampled==1])
            kpop_b16 <- svydesign(~1, data = pew, 
                                  weights = weights[[4]]$kpop_w[kbal_data_sampled==1])
            kpop_b8 <- svydesign(~1, data = pew, 
                                 weights = weights[[3]]$kpop_w[kbal_data_sampled==1])
            kpop_b4 <- svydesign(~1, data = pew, 
                                 weights = weights[[2]]$kpop_w[kbal_data_sampled==1])
            kpop_b2 <- svydesign(~1, data = pew, 
                                 weights = weights[[1]]$kpop_w[kbal_data_sampled==1])
            
            kpop_b32_conv <- svydesign(~1, data = pew, 
                                       weights = 
                                           weights[[5]]$kpop_w_conv[kbal_data_sampled==1])
            kpop_b16_conv <- svydesign(~1, data = pew, 
                                       weights =
                                          weights[[4]]$kpop_w_conv[kbal_data_sampled==1])
            kpop_b8_conv <- svydesign(~1, data = pew, 
                                      weights =
                                          weights[[3]]$kpop_w_conv[kbal_data_sampled==1])
            kpop_b4_conv <- svydesign(~1, data = pew, 
                                      weights =
                                          weights[[2]]$kpop_w_conv[kbal_data_sampled==1])
            kpop_b2_conv <- svydesign(~1, data = pew, 
                                      weights =
                                          weights[[1]]$kpop_w_conv[kbal_data_sampled==1])
            
            kpop_mf_b32 <- svydesign(~1, data = pew, 
                                     weights =
                                         weights[[5]]$kpop_mf_w[kbal_data_sampled==1])
            kpop_mf_b16 <- svydesign(~1, data = pew, 
                                     weights =
                                         weights[[4]]$kpop_mf_w[kbal_data_sampled==1])
            kpop_mf_b8 <- svydesign(~1, data = pew, 
                                    weights =
                                        weights[[3]]$kpop_mf_w[kbal_data_sampled==1])
            kpop_mf_b4 <- svydesign(~1, data = pew, 
                                    weights =
                                        weights[[2]]$kpop_mf_w[kbal_data_sampled==1])
            kpop_mf_b2 <- svydesign(~1, data = pew, 
                                    weights =
                                        weights[[1]]$kpop_mf_w[kbal_data_sampled==1])
        }
       

     if(popw) {
        cces_svy = svydesign(ids = ~1, weights = ~commonweight_vv_post, data = cces)
    } else {
        cces_svy = suppressWarnings(svydesign(ids = ~1,  data = cces))
    }
    
    targets_rake_demos_noeduc <- create_targets(cces_svy, 
                                                    formula_rake_demos_noeduc)
    targets_rake_demos_weduc <- create_targets(cces_svy, 
                                               formula_rake_demos_weduc)
    targets_rake_all_vars <- create_targets(cces_svy, 
                                               formula_rake_all_vars)
    targets_retrospective <- create_targets(cces_svy,
                                            formula_retrospective)
    targets_ps <- svytable(formula = ~strata,
                           design = subset(cces_svy,
                                           !(strata %in% missing_strata)))
    targets_ps_reduc <- svytable(formula = ~strata_reduc,
                       design = subset(cces_svy, !(strata_reduc %in%
                                                        missing_strata_reduc)))
    targets_ps_all <- svytable(formula = ~strata_all,
                       design = subset(cces_svy, !(strata_all %in%
                                                        missing_strata_all)))
     
     
    rake_demos_noeduc <- calibrate(design = pew_srs,
                                   formula = formula_rake_demos_noeduc,
                                   population = targets_rake_demos_noeduc,
                                   calfun = "raking")
    
    rake_demos_noeduc <- svydesign(~1, data = pew,
                                   weights = weights(rake_demos_noeduc))
    
    ## Raking on demographics, including education
    rake_demos_weduc <- calibrate(design = pew_srs,
                                  formula = formula_rake_demos_weduc,
                                  population = targets_rake_demos_weduc,
                                  calfun = "raking")
    
    rake_demos_weduc <- svydesign(~1, data = pew, weights =
                                      weights(rake_demos_weduc))
    #rake all
    rake_all_vars <- calibrate(design = pew_srs,
                                  formula = formula_rake_all_vars,
                                  population = targets_rake_all_vars,
                                  calfun = "raking")
    
    rake_all_vars <- svydesign(~1, data = pew, weights =
                                      weights(rake_all_vars))
    
    ## Post-stratification
    pew_ps <- suppressWarnings(svydesign(ids = ~1, data = pew %>% filter(!(strata %in% problem))))
    post_stratification <- postStratify(design = pew_ps,
                                        strata = ~strata,
                                        population = targets_ps)
    post_stratification <- svydesign(~1, 
                                     data = pew %>% filter(!(strata %in% problem)),
                                     weights = weights(post_stratification))
    #reduced
    pew_ps_reduc_xgb <- suppressWarnings(svydesign(ids = ~1, data = pew %>% 
                                      filter(!(strata_reduc %in% problem_reduc))))
    post_strat_reduc <- postStratify(design = pew_ps_reduc_xgb,
                                        strata = ~strata_reduc,
                                        population = targets_ps_reduc)
    post_strat_reduc <- svydesign(~1, 
                                  data = pew %>%filter(!(strata_reduc %in%
                                                                 problem_reduc)),
                                     weights = weights(post_strat_reduc))
    
    pew_ps_all_xgb <- suppressWarnings(svydesign(ids = ~1, 
                                data = pew %>% filter(!(strata_all %in% problem_all))))
    post_strat_all <- postStratify(design = pew_ps_all_xgb,
                                        strata = ~strata_all,
                                        population = targets_ps_all)
    post_strat_all <- svydesign(~1,
                                data = pew %>% filter(!(strata_all %in% problem_all)),
                                weights = weights(post_strat_all))
    
    
    rake_retrospective <- calibrate(design = pew_srs,
                                    formula = formula_retrospective,
                                    population = targets_retrospective,
                                    calfun = "raking",
                                    force = TRUE)
    rake_retrospective <- svydesign(~1, data = pew,
                                    weights = weights(rake_retrospective))
        
    
    ########### Get Estimates #########
    df_build <- function(var_orig, var_cces, var_pew, vote_form = vote_diff,
                         real = FALSE, bigB, smallB) {
        if(!real) {
          df <- data.frame(
            cces_orig = svycontrast(svymean(as.formula(paste0("~", var_orig)), 
                                            cces_svy, na.rm = TRUE),
                                    vote_form),
            #this is cces modeled outcome on cces
            cces_mod = svymean(as.formula(paste0("~", var_cces)), cces_svy, na.rm = TRUE),
            
            #outcome = modeled cces predicted with pew (cces on pew)
            unweighted = svymean(as.formula(paste0("~", var_pew)), pew_srs,
                                 na.rm = TRUE),
            pew_weighted = svymean(as.formula(paste0("~", var_pew)), pew_w_srs, 
                                   na.rm = TRUE),
            rake_demos_noeduc = svymean(as.formula(paste0("~", var_pew)), 
                                        rake_demos_noeduc, na.rm = TRUE),
            rake_demos_weduc = svymean(as.formula(paste0("~", var_pew)), 
                                       rake_demos_weduc, na.rm = TRUE),
            rake_all_vars = svymean(as.formula(paste0("~", var_pew)), 
                                       rake_all_vars, na.rm = TRUE),
            post_stratification = svymean(as.formula(paste0("~", var_pew)), 
                                          post_stratification,
                                          na.rm = TRUE),
            post_strat_reduc = svymean(as.formula(paste0("~", var_pew)), 
                                          post_strat_reduc,
                                          na.rm = TRUE),
            post_strat_all = svymean(as.formula(paste0("~", var_pew)), 
                                          post_strat_all,
                                          na.rm = TRUE),
            rake_retrospective = svymean(as.formula(paste0("~", var_pew)),
                                         rake_retrospective, 
                                         na.rm = TRUE),
            kpop_bmean = svymean(as.formula(paste0("~", var_pew)), kpop_bmean, 
                                 na.rm = TRUE),
            kpop_bmean_conv = svymean(as.formula(paste0("~", var_pew)), kpop_bmean_conv,
                                      na.rm = TRUE),
            kpop_mf_bmean = svymean(as.formula(paste0("~", var_pew)), kpop_mf_bmean, 
                                    na.rm = TRUE),
            
            kpop_bmaxvar =svymean(as.formula(paste0("~", var_pew)), kpop_bmaxvar,
                                  na.rm = TRUE),
            kpop_bmaxvar_conv =svymean(as.formula(paste0("~", var_pew)), 
                                       kpop_bmaxvar_conv, na.rm = TRUE),
            kpop_mf_bmaxvar = svymean(as.formula(paste0("~", var_pew)), 
                                      kpop_mf_bmaxvar, na.rm = TRUE),
            kpop_b2048 = if( bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b2048,
                        na.rm = TRUE) } else {
                    NA},
            kpop_b1024 = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b1024,
                        na.rm = TRUE) } else {
                    NA},
            kpop_b512 = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b512,
                        na.rm = TRUE) } else {
                    NA},
            kpop_b256 = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b256, 
                        na.rm = TRUE) } else {
                    NA},
            kpop_b128 = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b128, 
                        na.rm = TRUE) } else {
                    NA},
            kpop_b64 = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b64, 
                        na.rm = TRUE) } else {
                    NA},
            kpop_b32 = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b32, 
                        na.rm = TRUE)  } else {
                    NA},
            kpop_b16 = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b16, 
                        na.rm = TRUE)  } else {
                    NA},
            kpop_b8 = 
                if(smallB) { 
                 svymean(as.formula(paste0("~", var_pew)), kpop_b8, 
                         na.rm = TRUE) } else {
                    NA},
            kpop_b4 = 
                if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b4, 
                        na.rm = TRUE) } else {
                    NA},
            kpop_b2 = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b2,
                        na.rm = TRUE)} else { NA},
            
            kpop_b2048_conv = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b2048_conv,
                        na.rm = TRUE) } else {
                    NA},
            kpop_b1024_conv = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b1024_conv,
                        na.rm = TRUE) } else {
                    NA},
            
            kpop_b512_conv = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b512_conv,
                        na.rm = TRUE) } else {
                    NA},
            kpop_b256_conv = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b256_conv, 
                        na.rm = TRUE) } else {
                    NA},
            kpop_b128_conv = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b128_conv, 
                        na.rm = TRUE) } else {
                    NA},
            kpop_b64_conv = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), 
                        kpop_b64_conv, na.rm = TRUE) } else {  NA},
            kpop_b32_conv = if(smallB) { 
               svymean(as.formula(paste0("~", var_pew)), kpop_b32_conv,
                                    na.rm = TRUE) } else {
                    NA},
            kpop_b16_conv = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b16_conv, 
                                    na.rm = TRUE) } else {
                    NA},
            kpop_b8_conv = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b8_conv,
                                   na.rm = TRUE) } else {
                    NA},
            kpop_b4_conv = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b4_conv, 
                                   na.rm = TRUE) } else {
                    NA},
            kpop_b2_conv = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_b2_conv, 
                                   na.rm = TRUE) } else {
                    NA},
            
            kpop_mf_b2048 = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_mf_b2048,
                        na.rm = TRUE) } else {
                    NA},
            kpop_mf_b1024 = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_mf_b1024,
                        na.rm = TRUE) } else {
                    NA},
            kpop_mf_b512 = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_mf_b512,
                        na.rm = TRUE) } else {
                    NA},
            kpop_mf_b256 = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_mf_b256, 
                        na.rm = TRUE) } else {
                    NA},
            kpop_mf_b128 = if(bigB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_mf_b128, 
                        na.rm = TRUE) } else {
                            NA},
            
            kpop_mf_b64 = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_mf_b64,
                        na.rm = TRUE) }  else { NA},
            kpop_mf_b32 = if(smallB) { 
               svymean(as.formula(paste0("~", var_pew)), kpop_mf_b32,
                                  na.rm = TRUE) } else { NA},
            kpop_mf_b16 = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_mf_b16, 
                                  na.rm = TRUE) } else { NA},
            kpop_mf_b8 = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_mf_b8, 
                                 na.rm = TRUE) }  else { NA},
            kpop_mf_b4 = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_mf_b4, 
                                 na.rm = TRUE) }  else { NA},
            kpop_mf_b2 = if(smallB) { 
                svymean(as.formula(paste0("~", var_pew)), kpop_mf_b2,
                                 na.rm = TRUE) }  else { NA}) %>%
    pivot_longer(cols = everything(),
                         names_to = c("source", ".value"), 
                         names_pattern = "(.*)\\.(.*)") 
          
            df$SE <- coalesce(df[[var_cces]], df[[var_pew]], df$SE)
            df <- df %>% mutate(est = coalesce(nlcon, mean))
        } else {
            df <- data.frame(
                cces_orig = svycontrast(svymean(~recode_vote_2016, 
                                                cces_svy, na.rm = TRUE),
                                        vote_form),
                #outcome = modeled cces predicted with pew (cces on pew)
                unweighted = svycontrast(svymean(~recode_vote_2016, 
                                                 pew_srs, na.rm = TRUE),
                                         vote_form),
                pew_weighted = svycontrast(svymean(~recode_vote_2016, 
                                                   pew_w_srs, na.rm = TRUE),
                                           vote_form),
                
                rake_demos_noeduc = svycontrast(svymean(~recode_vote_2016, 
                                                        rake_demos_noeduc, na.rm = TRUE),
                                                vote_form),
                rake_demos_weduc = svycontrast(svymean(~recode_vote_2016, 
                                                       rake_demos_weduc, na.rm = TRUE),
                                               vote_form),
                rake_all_vars = svycontrast(svymean(~recode_vote_2016, 
                                                       rake_all_vars, na.rm = TRUE),
                                               vote_form),
                post_stratification = svycontrast(svymean(~recode_vote_2016, 
                                                          post_stratification,
                                                          na.rm = TRUE),
                                                  vote_form),
                post_strat_reduc = svycontrast(svymean(~recode_vote_2016, 
                                                          post_strat_reduc,
                                                          na.rm = TRUE),
                                                  vote_form),
                post_strat_all = svycontrast(svymean(~recode_vote_2016, 
                                                          post_strat_all,
                                                          na.rm = TRUE),
                                                  vote_form),
                rake_retrospective = svycontrast(svymean(~recode_vote_2016, 
                                                         rake_retrospective,
                                                         na.rm = TRUE),
                                                 vote_form),
            
                kpop_bmean = svycontrast(svymean(~recode_vote_2016,
                                                  kpop_bmean, na.rm = TRUE), vote_form),
                kpop_bmean_conv =svycontrast(svymean(~recode_vote_2016,
                                                  kpop_bmean_conv, na.rm = TRUE), vote_form),
                kpop_mf_bmean = svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_bmean, na.rm = TRUE), vote_form),
                
                kpop_bmaxvar = svycontrast(svymean(~recode_vote_2016,
                                                  kpop_bmaxvar, na.rm = TRUE), vote_form),
                kpop_bmaxvar_conv = svycontrast(svymean(~recode_vote_2016,
                                                  kpop_bmaxvar_conv, na.rm = TRUE), vote_form),
                kpop_mf_bmaxvar = svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_bmaxvar, na.rm = TRUE), vote_form),
        
                kpop_b2048 = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b2048, na.rm = TRUE),
                                          vote_form)  } else {
                        NA},
                kpop_b1024 = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b1024, na.rm = TRUE),
                                          vote_form)  } else {
                        NA},
                kpop_b512 = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b512, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b256 = if(bigB) { 
                   svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b256, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b128 = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b128, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b64 = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b64, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b32 = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                               kpop_b32, na.rm = TRUE),
                                       vote_form) } else {
                        NA},
                kpop_b16 = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                               kpop_b16, na.rm = TRUE),
                                       vote_form) } else {
                        NA},
                kpop_b8 = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                              kpop_b8, na.rm = TRUE),
                                      vote_form) } else {
                        NA},
                kpop_b4 = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                              kpop_b4, na.rm = TRUE),
                                      vote_form) } else {
                        NA},
                kpop_b2 = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                              kpop_b2, na.rm = TRUE),
                                      vote_form)} else {
                        NA},
                
                
                kpop_b2048_conv = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b2048_conv, na.rm = TRUE),
                                          vote_form)  } else {
                        NA},
                kpop_b1024_conv = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b1024_conv, na.rm = TRUE),
                                          vote_form)  } else {
                        NA},
                kpop_b512_conv = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b512_conv, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b256_conv = if(bigB) { 
                   svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b256_conv, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b128_conv = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b128_conv, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b64_conv = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b64_conv, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b32_conv = if(smallB) { 
                          svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b32_conv, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b16_conv = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b16_conv, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b8_conv = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b8_conv, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b4_conv = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b4_conv, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_b2_conv = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_b2_conv, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                
                kpop_mf_b2048 = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_b2048, na.rm = TRUE),
                                          vote_form)  } else {
                        NA},
                kpop_mf_b1024 = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_b1024, na.rm = TRUE),
                                          vote_form)  } else {
                        NA},
                kpop_mf_b512 = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_b512, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_mf_b256 = if(bigB) { 
                   svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_b256, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_mf_b128 = if(bigB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_b128, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                
                kpop_mf_b64 = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_b64, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_mf_b32 =  if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_b32, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_mf_b16 = if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_b16, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_mf_b8 =  if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_b8, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_mf_b4 =  if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_b4, na.rm = TRUE),
                                          vote_form) } else {
                        NA},
                kpop_mf_b2 =  if(smallB) { 
                    svycontrast(svymean(~recode_vote_2016,
                                                  kpop_mf_b2, na.rm = TRUE),
                                          vote_form) } else {
                        NA}
            ) %>%
                pivot_longer(cols = everything(),
                             names_to = c("source", ".value"), 
                             names_pattern = "(.*)\\.(.*)") 
            
            df <- df %>% rename(est = nlcon)
            
        }
        df <- df %>% filter(!is.na(source))
        #if(!bigB) {df <- df %>% filter(!is.na(source))}
        #some manual fixing of names 
        df <- df %>% 
            dplyr::select(source, est, SE) %>%
            mutate(est = est * 100,
                   SE = SE * 100,
                   #err_target = est - target_diff * 100,
                   source = str_replace(source, "_", " "))
        
        
        b_num = c(rep(out_cat$b[1], 3), rep(out_cat$b[2], 3) ) 
        rep <- NULL
        if(bigB) {
            rep <- c(2048,1024,512,256,128)
        }
        if(smallB) {
            rep = c(rep, c(64,32,16,8,4,2)) 
        }
        b_num <- c(b_num, rep(rep, 3))
        
        df$b <- NA
        df$b[grep("b", df$source) ]<- b_num
        df$MF <- "NA"
        df$MF[grep("mf", df$source)] <- "MF"
        df$MF[!grepl("mf", df$source) & grepl("kpop", df$source)]<- "No MF"
        df$Conv <- "NA"
        df$Conv[!grepl("conv", df$source) & 
                              grepl("kpop", df$source)]<- "Conv Not Required"
        df$Conv[c(grep("conv", df$source),
                            grep("mf", df$source))] <- "Conv Required"
        df <- df %>% arrange(!is.na(b), b)
        df <- df %>% 
            mutate(source_name = factor(source, 
                                        levels = as.character(df$source) ,
                                        labels = c("CCES Orig",
                                                   if(!real){"CCES Modeled"},
                                                   "Pew Unweighted", 
                                                   "Pew Weights",
                                                   "Mean Calibration (Demos)", 
                                                   "Mean Calibration (Demos w/Edu)", 
                                                   "Mean Calibration (All)",
                                                   "Post-Strat (former)", 
                                                   "Post-Strat (Reduced)",
                                                   "Post-Strat (all)",
                                                   "mean Calibration (Retrospective)", 
                                                   
                                                   if(smallB) {"Kpop b=2x"},
                                                   if(smallB) {"Kpop MF b=2x"},
                                                   if(smallB) {"Kpop Conv b=2x"},
                                                   
                                                   if(smallB) {"Kpop b=4x"},
                                                   if(smallB) {"Kpop Conv b=4x"},
                                                   if(smallB) {"Kpop MF b=4x"},
                                                   
                                                   "Kpop b=mean",
                                                   "Kpop Conv b=mean",
                                                   "Kpop MF b=mean",
                                                   
                                                    if(smallB) {"Kpop b=8x"},
                                                    if(smallB) {"Kpop Conv b=8x"},
                                                    if(smallB) {"Kpop MF b=8x"},
                                                   
                                                    "Kpop b=argmax var K*2",
                                                    "Kpop Conv b=argmax var(K)*2",
                                                    "Kpop MF b=argmax var(K)*2",
                                                
                                                    if(smallB) {"Kpop b=16x"},
                                                    if(smallB) {"Kpop MF b=16x"},
                                                    if(smallB) {"Kpop Conv b=16x"},
                                            
                                            
                                                    if(smallB) {"Kpop b=32x"},
                                                    if(smallB) {"Kpop Conv b=32x"},
                                                    if(smallB) {"Kpop MF b=32x"},
                                            
                                                    if(smallB) {"Kpop b=64x"},
                                                    if(smallB) {"Kpop Conv b=64x"},
                                                    if(smallB) {"Kpop MF b=64x"},
                                            
                                                    if(bigB) {"Kpop b=128x"},
                                                    if(bigB) {"Kpop Conv b=128x"},
                                                    if(bigB) {"Kpop MF b=128x"},
                                            
                                                    if(bigB) {"Kpop b=256x"},
                                                    if(bigB) {"Kpop Conv b=256x"},
                                                    if(bigB) {"Kpop MF b=256x"},
                                            
                                                    if(bigB) {"Kpop b=512x"},
                                                    if(bigB) {"Kpop Conv b=512x"},
                                                    if(bigB) {"Kpop MF b=512x"},
                                            
                                                    if(bigB) {"Kpop b=1024x"},
                                                    if(bigB) {"Kpop Conv b=1024x"},
                                                    if(bigB) {"Kpop MF b=1024x"},
                                            
                                                    if(bigB) {"Kpop b=2048x"},
                                                    if(bigB) {"Kpop Conv b=2048x"},
                                                    if(bigB) {"Kpop MF b=2048x"}
                                            
                                            )))
        df <- df %>% filter(!is.na(est))
        
        return(df)
    }
    
    comp_df_diff <- df_build("recode_vote_2016", "diff_cces_on_cces", "diff_cces_on_pew",
                             bigB = bigB, smallB = smallB)
    
    comp_df_diff_pewoutcome <- df_build("recode_vote_2016", 
                                        "diff_pew_on_cces",
                                        "diff_pew_on_pew",
                                        bigB = bigB, smallB = smallB) 
    
    comp_df_margin <- df_build("recode_vote_2016", 
                                        "margin_cces_on_cces",
                                        "margin_cces_on_pew",
                               bigB = bigB,  smallB = smallB)  
  
    
    comp_df_margin_pewoutcome <- df_build("recode_vote_2016", 
                                          "margin_pew_on_cces",
                                          "margin_pew_on_pew",
                                          bigB = bigB,
                                           smallB = smallB)  
    
    
    comp_df_pR <- df_build("recode_vote_2016", 
                           "mod_cces_on_cces_pR",
                           "mod_cces_on_pew_pR",
                           bigB = bigB,
                            smallB = smallB,
                            vote_form = quote((recode_vote_2016Republican  +recode_vote_2016Republican)/2 ))  
    
    comp_df_pR_pewoutcome <- df_build("recode_vote_2016", 
                           "mod_pew_on_cces_pR",
                           "mod_pew_on_pew_pR",
                           bigB = bigB,
                            smallB = smallB,
                           vote_form = quote((recode_vote_2016Republican  +recode_vote_2016Republican)/2 )) 
   
    
    comp_df_pD <- df_build("recode_vote_2016", 
                           "mod_cces_on_cces_pD",
                           "mod_cces_on_pew_pD",
                           bigB = bigB, smallB = smallB,
                           vote_form = quote((recode_vote_2016Democrat +recode_vote_2016Democrat)/2 )) 
   
        
    comp_df_pD_pewoutcome <- df_build("recode_vote_2016", 
                           "mod_pew_on_cces_pD",
                           "mod_pew_on_pew_pD",
                           vote_form = quote((recode_vote_2016Democrat +recode_vote_2016Democrat)/2 ),
                           bigB = bigB, smallB = smallB)  
    
    
    comp_df_real <- df_build("recode_vote_2016", 
                           "recode_vote_2016",
                           "recode_vote_2016",
                           real = TRUE, 
                           vote_form = vote_contrast,
                           bigB = bigB,
                            smallB = smallB)
    
    
    comp_df_real_diff <-  df_build("recode_vote_2016", 
                           "recode_vote_2016",
                           "recode_vote_2016",
                           real = TRUE, bigB = bigB, 
                            smallB = smallB) 
    
    if(!is.null(indiv_b)) {
        if(indiv_b == "maxvar") {
            indiv_b = clean$b[2]
        } else if(indiv_b == "mean") {
            indiv_b = clean$b[1]
        }
        
        comp_df_diff <- comp_df_diff %>% filter(is.na(b) | b == indiv_b)
        comp_df_diff_pewoutcome <- comp_df_diff_pewoutcome %>% filter(is.na(b) | b == indiv_b)
        comp_df_margin <- comp_df_margin %>% filter(is.na(b) | b == indiv_b)
        comp_df_margin_pewoutcome <- comp_df_margin_pewoutcome %>% filter(is.na(b) | b == indiv_b)
        comp_df_pR <- comp_df_pR %>% filter(is.na(b) | b == indiv_b)
        comp_df_pR_pewoutcome <- comp_df_pR_pewoutcome %>% filter(is.na(b) | b == indiv_b)
        comp_df_pD <- comp_df_pD %>% filter(is.na(b) | b == indiv_b)
        comp_df_pD_pewoutcome <- comp_df_pD_pewoutcome %>% filter(is.na(b) | b == indiv_b)
        comp_df_real <- comp_df_real %>% filter(is.na(b) | b == indiv_b)
        comp_df_real_diff <- comp_df_real_diff %>% filter(is.na(b) | b == indiv_b)
    
        best_b <-comp_df_diff %>% select(source_name)
        
    } else {
        b_default <- clean %>% filter(max(bbr) == bbr) %>% dplyr::select(b) %>% pull()
        b_conv <- clean %>% filter(max(bbr_conv) == bbr_conv) %>% 
            dplyr::select(b) %>% pull()
        b_mf <- clean %>% filter(max(bbr_mf) == bbr_mf) %>% 
            dplyr::select(b)%>% pull()
        best_b <- c(as.character((comp_df_diff %>% filter(b == b_default) %>%
                     dplyr::select(source_name))[1,] %>% pull()),
                    as.character((comp_df_diff %>% filter(b == b_conv) %>%
                         dplyr::select(source_name))[2,] %>% pull()),
                    as.character((comp_df_diff %>% filter(b == b_mf) %>%
                         dplyr::select(source_name))[3,] %>% pull()))
        best_b
        if(!best_b_plot) {
            best_b <- c("Kpop b=argmax var",
                        "Kpop Conv b=argmax var",
                        "Kpop MF b=argmax var")
        }
        
    }
    
    if(clean_nonkpop) {
        if(is.null(specify_nonkpop)) {
            select_nonkpop <- c("CCES Orig", "CCES Modeled",
                                     "Pew Unweighted", 
                                     "Mean Calibration (Demos)", 
                                     "Mean Calibration (Demos w/Edu)", 
                                     "Mean Calibration (All)",
                                     "Mean Calibration (Retrospective)",
                                     "Post-Strat (Reduced)")
        }
        
       comp_df_diff <- comp_df_diff %>% 
           filter(source_name %in% select_nonkpop | grepl("Kpop", source_name))
        comp_df_diff_pewoutcome <- comp_df_diff_pewoutcome %>% 
            filter(source_name %in% select_nonkpop | grepl("Kpop", source_name))
        
        comp_df_margin <- comp_df_margin %>% 
            filter(source_name %in% select_nonkpop | grepl("Kpop", source_name))
        comp_df_margin_pewoutcome <- comp_df_margin_pewoutcome %>% 
            filter(source_name %in% select_nonkpop | grepl("Kpop", source_name))
        
        comp_df_pR <- comp_df_pR %>% 
            filter(source_name %in% select_nonkpop | grepl("Kpop", source_name))
        comp_df_pR_pewoutcome <- comp_df_pR_pewoutcome %>%
            filter(source_name %in% select_nonkpop | grepl("Kpop", source_name))
        
         comp_df_pD <- comp_df_pD %>% 
            filter(source_name %in% select_nonkpop | grepl("Kpop", source_name))
        comp_df_pD_pewoutcome <- comp_df_pD_pewoutcome %>%
            filter(source_name %in% select_nonkpop | grepl("Kpop", source_name))
        
        comp_df_real <- comp_df_real %>% 
            filter(source_name %in% select_nonkpop | grepl("Kpop", source_name))
        comp_df_real_diff <- comp_df_real_diff %>%
            filter(source_name %in% select_nonkpop | grepl("Kpop", source_name))
    }
    
    
    ######## PLOT ESTIMATES: Pre-wave Indiv Average Margin ########
    pew_ver = "Pre-Wave"
 
    if(popw) {
        popw_lab = "w/Pop W."
        mod_lab = "Lasso (lambda 1se) Modeled"
    } else {
        popw_lab = "No Pop W."
        mod_lab = "XGB Modeled"
    }
    tol_label = paste0(" tol=",as.character(tolerance))
    maxit_label = paste0( "maxit=", as.character(maxit))
    
    
    pres <- readRDS(paste0(path_data, "election.rds"))
    
    natl_margin <- pres %>%
        summarise(margin = (sum(demtotal) - sum(reptotal)) /
                      (sum(demtotal) + sum(reptotal))) %>%
        as.numeric()
    
    natl_diff <- pres %>%
        summarise(margin = (sum(demtotal) - sum(reptotal)) /
                      (sum(totalvotes))) %>%
        as.numeric()

    natl_Rep <- pres %>%
        summarise(pR =  sum(reptotal) /
                      sum(totalvotes)) %>%
        as.numeric()
    natl_Dem <- pres %>%
        summarise(pR =  sum(demtotal) /
                      sum(totalvotes)) %>%
        as.numeric()
    

    ###################
     #### merge together for aethetics on ggplot
    comp_df_margin_merge <- rbind(comp_df_margin, comp_df_margin_pewoutcome) %>% 
        mutate(model = c(rep("Modeled CCES",nrow(comp_df_margin)), 
                      rep(paste("Modeled", pew_ver, "Pew"),
                          nrow(comp_df_margin_pewoutcome)) ) )
    
    comp_df_diff_merge <- rbind(comp_df_diff, comp_df_diff_pewoutcome) %>% 
        mutate(model = c(rep("Modeled CCES",nrow(comp_df_margin)), 
                      rep(paste("Modeled", pew_ver, "Pew"),
                          nrow(comp_df_margin_pewoutcome)) ) )
    
    comp_df_pD_merge <- rbind(comp_df_pD, comp_df_pD_pewoutcome) %>% 
        mutate(model = c(rep("Modeled CCES",nrow(comp_df_margin)), 
                      rep(paste("Modeled", pew_ver, "Pew"),
                          nrow(comp_df_margin_pewoutcome)) ) )
    
    comp_df_pR_merge <- rbind(comp_df_pR, comp_df_pR_pewoutcome) %>% 
        mutate(model = c(rep("Modeled CCES",nrow(comp_df_margin)), 
                      rep(paste("Modeled", pew_ver, "Pew"),
                          nrow(comp_df_margin_pewoutcome)) ) )
    
    
    #droping wegithed pew estimates if dn ask for popw
    if(!popw) {
        comp_df_diff_merge <- comp_df_diff_merge[-which(comp_df_diff_merge$source == "pew weighted"), ]
        
        comp_df_margin_merge <- comp_df_margin_merge[-which(comp_df_margin_merge$source == "pew weighted"), ]
       
        comp_df_pR_merge <- comp_df_pR_merge[-which(comp_df_pR_merge$source == "pew weighted"), ]
        
        comp_df_pD_merge <- comp_df_pD_merge[-which(comp_df_pD_merge$source == "pew weighted"), ]
        
        comp_df_real <- comp_df_real[-which(comp_df_real$source == "pew weighted"), ]
        comp_df_real_diff <- comp_df_real_diff[-which(comp_df_real_diff$source == "pew weighted"), ]
    }
    
    ############plots
    
    
    comp_df_plot_real_margin <-
        ggplot() +
        aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE,
            color = as.factor(Conv), shape=as.factor(MF)) +
        
        geom_hline(yintercept = c(0, if(popw) {natl_margin*100},
                                  comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"]),
                   linetype = c("solid", if(popw) {"dashed"}, "longdash"),
                   color = c("black", if(popw){"gray60"}, "black")) +
        geom_pointrange(data = comp_df_real) +
        scale_y_continuous(breaks = c(natl_margin, seq(-5, 10, 5)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        
        labs(x = NULL, y = "Estimated Vote Margin (95% CI)") +
        ggtitle(paste(pew_ver, " Pew on TRUE CCES Vote Margin\n", popw_lab, tol_label, maxit_label)) +
        theme(axis.text.x = element_text(angle = 70, hjust = 1,
                                         face=ifelse(comp_df_real$source_name %in% 
                                                        best_b,
                                                    "bold","plain")
                                        )) +
        annotate(geom = "text", x = nrow(comp_df_real)+1.35,
                 y = if(popw){natl_margin * 100} else {comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"] },
                 label = if(popw) {" True\n National\n Margin"} else {""},
                 hjust = 0, angle = -90,
                 color = "gray60", size = 3) +
        annotate(geom = "text", x = nrow(comp_df_real)+1,
                 y = comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"],
                 label = if(popw)" Weighted\n CCES\n Target" else {" Unweighted\n CCES\n Target"},
                 hjust = 0, angle = 90, size = 3) +
        #for spacing
         annotate(geom = "text", x = nrow(comp_df_real)+2.65,
                 y = comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"],
                 label = " ",
                 hjust = 0, angle = 90, size = 3) +
        theme(legend.title = element_blank())
    
    
    comp_df_plot_real_diff <-
        ggplot() +
        aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE,
            color = as.factor(Conv), shape=as.factor(MF))  + 
        
        geom_hline(yintercept = c(0, if(popw){natl_diff*100},
                                  comp_df_real_diff$est[comp_df_real_diff$source_name
                                                        =="CCES Orig"]),
                   linetype = c("solid", if(popw){"dashed"}, "longdash"),
                   color = c("black", if(popw) {"gray60"}, "black")) +
        geom_pointrange(data = comp_df_real_diff) +
        scale_y_continuous(breaks = c(natl_diff*100, seq(-5, 10, 5)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        
        labs(x = NULL, y = "Estimated Vote Difference (95% CI)") +
        ggtitle(paste(pew_ver, " Pew on TRUE CCES Vote Difference\n",  
                      popw_lab,   tol_label, maxit_label)) +
        theme(axis.text.x = element_text(angle = 70, hjust = 1,
                                         face=ifelse(comp_df_real_diff$source_name
                                                    %in% 
                                                       best_b,
                                                    "bold","plain")
                                         )) +
        annotate(geom = "text", 
                 x = nrow(comp_df_real_diff) +1.35,
                 y = if(popw) {natl_diff * 100} else {comp_df_real_diff$est[comp_df_real_diff$source_name == 
                                               "CCES\ Orig"]},
                 label = if(popw){" True\n National\n Diff"} else {""},
                 hjust = 0, angle = -90,
                 color = "gray60", size = 3) +
        annotate(geom = "text", x = nrow(comp_df_real_diff) +1,
                 y = comp_df_real_diff$est[comp_df_real_diff$source_name == 
                                               "CCES\ Orig"],
                 label = if(popw)" Weighted\n CCES\n Target" else {" Unweighted\n CCES\n Target"},
                 hjust = 0, angle = 90, size = 3) +
        #for spacing
         annotate(geom = "text", x = nrow(comp_df_real_diff) +2.75,
                 y = comp_df_real_diff$est[comp_df_real_diff$source_name == 
                                               "CCES Orig"],
                 label = " ",
                 hjust = 0, angle = 90, size = 3) +
        theme(legend.title = element_blank())
    
    
    
    comp_df_plot_diff <-
        ggplot() +
        aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE,
            color = as.factor(Conv), shape=as.factor(MF), 
            alpha = if(display_pew_mod) {as.factor(model)
                } else if(is.null(indiv_b)) {
                first <-  rep("", nrow(comp_df_diff))
                first[grep("Kpop", comp_df_diff$source_name)] <- "Alt B"
                first[grep(paste(best_b, collapse = "|"),
                           comp_df_diff$source_name)] <- ""
                first
                } else {
                NULL
                }
        ) +
        geom_hline(yintercept = c(0, 
                                  if(popw) {natl_diff*100},
                                 if(popw) {comp_df_diff$est[comp_df_diff$source_name == "CCES Orig"]},
                                  comp_df_diff$est[comp_df_diff$source_name == "CCES Modeled"]),
                   linetype = c("solid", 
                                if(popw) {"dashed"}, if(popw) {"longdash"},
                                "dashed"),
                   color = c("black", 
                             if(popw) {"gray60"}, if(popw) {"black"},
                             "purple")) +
        
        geom_pointrange(data = if(display_pew_mod) {comp_df_diff_merge} else {comp_df_diff}) +
        scale_y_continuous(breaks = c(natl_diff*100, seq(-5, 10, 5)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        
        labs(x = NULL, y = "Estimated Modeled Vote Difference (95% CI)") +
        ggtitle(paste(pew_ver, "Pew on CCES",mod_lab,"Mean Indiv Vote Diff p(D) - p(R)",
                      "modeled\n",  popw_lab,   tol_label, maxit_label)) +
        theme(axis.text.x = element_text(angle = 70, hjust = 1,
                                         face=if(smallB) {
                                             ifelse(comp_df_diff$source_name %in% 
                                                        best_b,
                                                    "bold","plain")
                                         } else {
                                                 rep("plain", nrow(comp_df_diff))
                                         })) +
        annotate(geom = "text", 
                 x =if(display_pew_mod) {nrow(comp_df_pR_merge)+0.55} else{nrow(comp_df_pR)+.55}, 
                 y = if(popw) {natl_diff * 100} else {comp_df_diff$est[comp_df_diff$source_name == "CCES Modeled"]},
                 label = if(popw) {" True\n National\n Diff"} else {""},
                 hjust = 0, angle = -90,
                 color = "gray60", size = 3) +
        annotate(geom = "text",
                 x = if(display_pew_mod) {nrow(comp_df_pR_merge)+.55} else{nrow(comp_df_pR)+.55},
                 y = comp_df_diff$est[comp_df_diff$source_name == "CCES Modeled"],
                 label = " CCES\n Modeled Target",
                 color = "purple",
                 hjust = 0, angle = 90, size = 3) +
        annotate(geom = "text", 
                 x = if(display_pew_mod) {nrow(comp_df_pR_merge)+1} else{nrow(comp_df_pR)+1}, 
                 y = if(popw) {comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"]} else { comp_df_diff$est[comp_df_diff$source_name == "CCES Modeled"]},
                 label = if(popw){" Weighted\n CCES\n Target"} else {""},
                 color = "black",
                 hjust = 0, angle = -90, size = 3) +
        #for spacing
        annotate(geom = "text", 
                 x = if(display_pew_mod) {nrow(comp_df_pR_merge)+2} else{nrow(comp_df_pR)+2},
                 y = comp_df_diff$est[comp_df_diff$source_name == "CCES Modeled"],
                 label = "",
                 color = "purple",
                 hjust = 0, angle = -90, size = 3) +
        
        theme(legend.title = element_blank())
    

    
    
    comp_df_plot_margin <-
        ggplot() +
        aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE,
            color = as.factor(Conv), shape=as.factor(MF), 
            alpha = if(display_pew_mod) {as.factor(model)
                } else if(is.null(indiv_b)) {
                first <-  rep("", nrow(comp_df_margin))
                first[grep("Kpop", comp_df_margin$source_name)] <- "Alt B"
                first[grep(paste(best_b, collapse = "|"),
                           comp_df_margin$source_name)] <- ""
                first
                } else {
                NULL
            }
        ) +
        geom_hline(yintercept = c(0, 
                                  if(popw) {natl_margin*100},
                                 if(popw) {comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"]},
                                  comp_df_margin$est[comp_df_margin$source_name == "CCES Modeled"]),
                   linetype = c("solid", 
                                if(popw) {"dashed"}, if(popw) {"longdash"},
                                "dashed"),
                   color = c("black", 
                             if(popw) {"gray60"}, if(popw){"black"},
                             "purple")) +
        geom_pointrange(data = if(display_pew_mod) {comp_df_margin_merge} else {comp_df_margin}) +
        #geom_pointrange(data = comp_df_margin_pewoutcome, alpha = 0.4) +
        scale_y_continuous(breaks = c(natl_margin, seq(-5, 10, 5)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        
        labs(x = NULL, y = "Estimated Modeled Vote Margin (95% CI)") +
        ggtitle(paste(pew_ver, "Pew on CCES", mod_lab, "Mean Indiv Vote Margin",
                       "modeled\n", popw_lab,   tol_label, maxit_label)) +
        theme(axis.text.x = element_text(angle = 70, hjust = 1,
                                         face=if(smallB) {
                                             ifelse(comp_df_margin$source_name %in% 
                                                        best_b,
                                                    "bold","plain")
                                         } else {
                                                 rep("plain", nrow(comp_df_margin))
                                         })) +
         annotate(geom = "text", 
                  x = if(display_pew_mod){nrow(comp_df_margin_merge)+0.55} else {nrow(comp_df_margin)+0.55}, 
                 y = if(popw) {natl_margin * 100} else {comp_df_margin$est[comp_df_margin$source_name == "CCES Modeled"]},
                 label = if(popw) {" True\n National\n Margin"} else {""},
                 hjust = 0, angle = -90,
                 color = "gray60", size = 3) +
        annotate(geom = "text", 
                 x = if(display_pew_mod){ nrow(comp_df_pR_merge)+.55}else{ nrow(comp_df_pR)+.55},
                 y = comp_df_margin$est[comp_df_margin$source_name == "CCES Modeled"],
                 label = " CCES\n Modeled Target",
                 color = "purple",
                 hjust = 0, angle = 90, size = 3) +
        annotate(geom = "text", 
                 x = if(display_pew_mod){ nrow(comp_df_pR_merge)+1} else { nrow(comp_df_pR)+1},
                 y = if(popw) {comp_df_margin$est[comp_df_margin$source_name == "CCES Orig"]} else {comp_df_margin$est[comp_df_margin$source_name == "CCES Modeled"]}, 
                 label = if(popw) {" Weighted\n CCES\n Target"} else {""},
                 color = "black",
                 hjust = 0, angle = -90, size = 3) +
        #for spacing
        annotate(geom = "text",
                 x = if(display_pew_mod){nrow(comp_df_pR_merge)+2} else {nrow(comp_df_pR)+2},
                 y = comp_df_margin$est[comp_df_margin$source_name == "CCES Modeled"],
                 label = "",
                 color = "purple",
                 hjust = 0, angle = -90, size = 3) +
        
        theme(legend.title = element_blank())
    
    
    ####### p(R) plot
    
    comp_df_plot_both_pR <-
        ggplot() +
        aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE,
            color = as.factor(Conv), shape=as.factor(MF), 
            alpha = if(display_pew_mod) {as.factor(model)
                } else if(is.null(indiv_b)) {
                first <-  rep("", nrow(comp_df_pR))
                first[grep("Kpop", comp_df_pR$source_name)] <- "Alt B"
                first[grep(paste(best_b, collapse = "|"),
                           comp_df_pR$source_name)] <- ""
                first
                } else {
                NULL
            }
        ) +
        
        geom_hline(yintercept = c(if(popw) {natl_Rep*100},
                                  if(popw) {comp_df_pR$est[comp_df_pR$source_name == "CCES Orig"]},
                                  comp_df_pR$est[comp_df_pR$source_name == "CCES Modeled"]),
                   linetype = c( if(popw) {"dashed"}, if(popw){"longdash"}, 
                                 "dashed"),
                   color = c(if(popw) {"gray60"},if(popw) {"black"},
                             "purple")) +
        geom_pointrange(data = if(display_pew_mod) {comp_df_pR_merge} else {comp_df_pR}) +
       # geom_pointrange(data = comp_df_pR_pewoutcome, alpha = 0.4) +
        scale_y_continuous(breaks = c(natl_Rep, seq(40, 48, 2)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        
        labs(x = NULL, y = "Estimated Modeled Vote p(R) (95% CI)") +
        ggtitle(paste(pew_ver,"Pew on CCES", mod_lab,  "p(R) modeled\n",
                      popw_lab,   tol_label, maxit_label)) +
        theme(axis.text.x = element_text(angle = 70, hjust = 1,
                                         face=if(smallB) {
                                             ifelse(comp_df_pR$source_name %in% 
                                                       best_b,
                                                    "bold","plain")
                                         } else {
                                                 rep("plain", nrow(comp_df_pR))
                                         })) +
        annotate(geom = "text", 
                 x = if(display_pew_mod){nrow(comp_df_pR_merge)+.35} else {nrow(comp_df_pR)+.35}, 
                 y = if(popw) {natl_Rep * 100} else {comp_df_pR$est[comp_df_pR$source_name == "CCES Modeled"]},
                 label = if(popw) {" True\n National\n % Rep"} else {""},
                 hjust = 0, angle = +90,
                 color = "gray60", size = 3) +
        annotate(geom = "text",
                 x = if(display_pew_mod){nrow(comp_df_pR_merge)+1} else {nrow(comp_df_pR)+1},
                 y = if(popw) {comp_df_pR$est[comp_df_pR$source_name == "CCES Orig"]} else {comp_df_pR$est[comp_df_pR$source_name == "CCES Modeled"]},
                 label = if(popw) {" Weighted\n CCES\n Target"} else {""},
                 hjust = 0, angle = -90, size = 3) +
        annotate(geom = "text",
                 x = if(display_pew_mod){nrow(comp_df_pR_merge)+.55} else {nrow(comp_df_pR)+.55},
                 y = comp_df_pR$est[comp_df_pR$source_name == "CCES Modeled"],
                 label = " CCES\n Modeled Target",
                 color = "purple",
                 hjust = 0, angle = 90, size = 3) +
        #for spacing
        annotate(geom = "text", 
                 x = if(display_pew_mod) {nrow(comp_df_pR_merge)+1.85} else {nrow(comp_df_pR)+1.75},
                 y = comp_df_pR$est[comp_df_pR$source_name == "CCES Modeled"],
                 label = "",
                 color = "purple",
                 hjust = 0, angle = -90, size = 3) +
        
        
        theme(legend.title = element_blank())
    
    
    
    ###### p(D) plot
    
    comp_df_plot_both_pD <-
        ggplot() +
        aes(x = source_name, y = est, ymin = est - 1.96*SE, ymax = est + 1.96*SE,
            color = as.factor(Conv), shape=as.factor(MF), 
            alpha = if(display_pew_mod) {as.factor(model)
                } else  if(is.null(indiv_b)) {
                first <-  rep("", nrow(comp_df_pD))
                
                first[grep("Kpop", comp_df_pD$source_name)] <- "Alt B"
                first[grep(paste(best_b, collapse = "|"),
                           comp_df_pD$source_name)] <- ""
                first
                } else {
                NULL
            }
        ) +
        
        geom_hline(yintercept = c(if(popw) {natl_Dem*100},
                                  if(popw) {comp_df_pD$est[comp_df_pD$source_name == "CCES Orig"]},
                                  comp_df_pD$est[comp_df_pD$source_name == "CCES Modeled"]),
                   linetype = c( if(popw) {"dashed"}, if(popw){"longdash"}, 
                                 "dashed"),
                   color = c(if(popw) {"gray60"},if(popw) {"black"},
                             "purple")) +
        geom_pointrange(data = if(display_pew_mod) {comp_df_pD_merge} else {comp_df_pD}) +
        #geom_pointrange(data = comp_df_pD_pewoutcome, alpha = 0.4) +
        scale_y_continuous(breaks = c(natl_Dem*100, seq(40, 56, 4)),
                           minor_breaks = NULL,
                           labels = scales::percent_format(scale=1, accuracy = 0.1)) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) +
        
        labs(x = NULL, y = "Estimated Modeled Vote p(R) (95% CI)") +
        ggtitle(paste(pew_ver, "Pew on CCES", mod_lab, "p(D) modeled\n",
                      popw_lab,   tol_label, maxit_label)) +
        theme(axis.text.x = element_text(angle = 70, hjust = 1,
                                         face=if(smallB) {
                                             ifelse(comp_df_pD$source_name %in% 
                                                        best_b,
                                                    "bold","plain")
                                         } else {
                                                 rep("plain", nrow(comp_df_pD))
                                         } )) +
        annotate(geom = "text", 
                 x = if(display_pew_mod){nrow(comp_df_pR_merge)+.35} else {nrow(comp_df_pR)+.35},
                 y = if(popw) {natl_Dem * 100} else {comp_df_pD$est[comp_df_pD$source_name == "CCES Orig"]},
                 label = if(popw){" True\n National\n % Rep"} else {""},
                 hjust = 0, angle = -90,
                 color = "gray60", size = 3) +
        annotate(geom = "text", 
                 x = if(display_pew_mod) {nrow(comp_df_pR_merge)+1}else {nrow(comp_df_pR)+1},
                 y = if(popw) {comp_df_pD$est[comp_df_pD$source_name == "CCES Orig"]} else { comp_df_pD$est[comp_df_pD$source_name == "CCES Modeled"]},
                 label = if(popw) {" Weighted\n CCES\n Target"} else {""},
                 hjust = 0, angle = 90, size = 3) +
        annotate(geom = "text", 
                 x = if(display_pew_mod)  {nrow(comp_df_pR_merge)+.55}else {nrow(comp_df_pR)+.55},
                 y = comp_df_pD$est[comp_df_pD$source_name == "CCES Modeled"],
                 label = " CCES\n Modeled Target",
                 color = "purple",
                 hjust = 0, angle = -90, size = 3) +
        annotate(geom = "text",
                 x = if(display_pew_mod) {nrow(comp_df_pR_merge)+1.65} else {nrow(comp_df_pR)+1.65},
                 y = comp_df_pD$est[comp_df_pD$source_name == "CCES Modeled"],
                 label = "",
                 color = "purple",
                 hjust = 0, angle = 90, size = 3) +
        
        theme(legend.title = element_blank() )
    

    
    ### output
    out <- list(orig_estimates = clean, 
                plot_diff = comp_df_plot_diff,
                plot_margin = comp_df_plot_margin,
                plot_pR = comp_df_plot_both_pR,
                plot_pD = comp_df_plot_both_pD,
                plot_real_margin = comp_df_plot_real_margin,
                plot_real_diff = comp_df_plot_real_diff,
                problem = problem,
                problem_reduc = problem_reduc,
                problem_all = problem_all,
                comp_df_diff = comp_df_diff_merge,
                comp_df_margin = comp_df_margin_merge,
                comp_df_pR = comp_df_pR_merge,
                comp_df_pD = comp_df_pD_merge, 
                comp_df_real_margin = comp_df_real,
                comp_df_real_diff = comp_df_real_diff)
    return(out)
}

```


```{r run_plot}
cat_kernel_popw <- pew_out(popw = TRUE,
                           bigB = TRUE, 
                           smallB = TRUE,
                      display_pew_mod = FALSE)

cat_kernel_popw$plot_real_diff
cat_kernel_popw$plot_diff
cat_kernel_popw$plot_real_margin
cat_kernel_popw$plot_margin
cat_kernel_popw$plot_pR
cat_kernel_popw$plot_pD

bmaxvar_kernel_popw <- pew_out(popw = TRUE,
                           bigB = FALSE, 
                           smallB = FALSE,
                           indiv_b = "maxvar",
                           clean_nonkpop = TRUE,
                      display_pew_mod = FALSE)

bmaxvar_kernel_popw$plot_diff

```


