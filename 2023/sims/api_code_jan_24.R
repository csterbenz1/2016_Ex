######### 
library(openai)


#### set up global api key
Sys.setenv(OPENAI_API_KEY= "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")



###### instructions: 669 tokens
instructions = list(role = "system", 
                    content = "You are classifying text from news media about foreign policy event and especially interested in identifying and coding government rhetoric about foreign policy. A foreign policy event represents an action by one country toward another country. If the text does not contain any foreign policy event, you will return no codings. If the text contains multiple foreign policy events, you will code each event for the following ten characteristics. \n1. You will first identify the topic of the text. \n2. Second, you will identify the specific foreign policy event in the text. Note that the event and the topic are distinct. The event describes what behavior occurred while the topic describes the topical content of that behavior. \n3. Third, you will classify the nature of the event itself as conflictual, neutral, cooperative. Note carefully that this is distinct from the expressed sentiment about the event. Here you are answering if the nature of event itself represents a cooperative action, a neutral action or a conflictual action. Note that an event in which a government pursues further interaction or discussion with another country is considered cooperative. For example, communication in a meeting or phone call is generally a cooperative action, regardless of the content of the phone call or meeting which may present hostile or cooperative sentiment. \n4. Fourth, you will identify the category of event as within diplomatic politics (e.g. meetings, speeches, phone calls, public statements), economic politics (e.g. trade, finance), or security politics (e.g. military behavior, arms, alliances, defense, conflict)\n5. Fifth, you will identify if the event is a material action or not. Here you are answering if the event concerns rhetorical statements only, or whether the event involved a material interaction of people or goods.\n6. Sixth, you will identify what countries are involved and the sentiment expressed toward each of the countries mentioned as weakly,  moderately, or strongly positive, neutral, or negative.\n7. Seventh, you will identify the direction of the event from what country toward what country. Here you are classifying which country is performing the action in the event toward what other country or countries. If both countries act, you will classify the action mutual.\n8. Eight, you will identify named governmental actors involved for all countries. If there are no named governmental actors, return None. You do not need to classify any non-governmental actors that are mentioned, like experts or researchers. \n9. Ninth, you will identify whether the text contains direct rhetoric from a government source, department or political elite representing the government for each country involved and note their position in government. Be sure to note all government speakers. When the text does not name an individual but quotes a department or entity representing the executive government code Yes. For example,  \"the white house stated\", or \"Beijing has said\" should be Yes.\n10. Tenth, you will identify if the text invokes nationalistic language, ideas, or issues and if so what nationalistic topic or theme. If the text glorifies national pride, identity, or history code Yes. If the event involves a historical grievances regarding wartime or colonial behavior, reparations, or historical memory code Yes. \nDo not omit any of the 10 categories at any time.  If the text does not contain a given text characteristic code it instead as None.")

#### examples
ex_1 =list(role = "user",
           content = "The United States is telling lies about China's policies in the Xinjiang and Tibet autonomous regions out of \"ulterior motives\", and China is firmly opposed to that, Beijing said on Monday.\" By disregarding truth and repeating lies time and again, the US has left itself in deficits of morality, credibility and reputation,\" Foreign Ministry spokesman Geng Shuang said. Geng made the remark at a daily news conference after a tweet by US Secretary of State Mike Pompeo on Saturday that attacked China's policies in Tibet and Xinjiang. The US Department of State posted a similar tweet the same day. \"The fact that China's Xinjiang and Tibet are enjoying political stability, economic development, ethnic unity and social harmony is the most powerful refutation of the US' slanderous words,\" Geng said. Xinjiang is witnessing sustained economic growth, social harmony and stability, as well as religious harmony, Geng said. The lives of people in Xinjiang have been improving, and cultures are prospering in the autonomous region, he said. The population of the Uygur ethnic group in Xinjiang has increased to 11.65 million, accounting for more than 46 percent of the region's population, Geng said. There are more than 24,000 mosques in Xinjiang, which means there is a mosque for every 530 Muslims there, he said. Speaking of the situation in Tibet, Geng said that since its peaceful liberation in 1951, the region has enjoyed vigorous economic growth and social stability, and its traditional culture has been protected and promoted. There are more than 1,700 venues for religious activities and about 46,000 monks and nuns in Tibet, and about one million religious people make pilgrimages to Lhasa, the regional capital, every year, he said. Instead of interfering in other countries' domestic affairs, the US should \"mind its own business\" and focus on addressing its own \"persistent problems\", Geng said, citing statistics from an Associated Press report. The report, published on Saturday, cited figures from a database that showed there were more mass killings in the US this year than in any year dating back to at least the 1970s. In 2019, there were 41 mass killings, defined as when four or more people are killed, excluding the perpetrator, of which 33 were mass shootings, the report said, adding that more than 210 people were killed.")
ex_1_coded = list(role= "assistant",
            content= "Topic: China’s Policies in Xinjian and Tibet\nEvent: Diplomatic Statement\nEvent Hostility: Neutral\nCategory: Diplomacy\nMaterial Action: No\nCountry Sentiment: US=Negative (strong), PRC=Positive (moderate)\nDirection: PRC to US\nGovernment Actors: Mike Pompeo (US), Geng Shuang (PRC)\nGovernment Rhetoric: US=Yes (Secretary of State), PRC = Yes (Foreign Ministry spokesman)\nNationalistic: No\n###")
ex_2 = list(role= "user",
            content= "President Moon Jae-in left for China on Monday morning for summits with the leaders of China and Japan. Moon stops in Beijing to meet with his Chinese counterpart Xi Jinping before moving to Chengdu for a trilateral summit with Xi and Japanese Prime Minister Shinzo Abe and a face-to-face meeting with Abe on Tuesday. Both bilateral meetings are expected to be difficult. The Korean and Japanese governments held several working-level meetings ahead of the summit to resolve issues that divide them, such as compensation for Korean forced labor victims, but there was no major progress. A Cheong Wa Dae official said, \"Discussions will begin to tackle the issue of [Japanese] export restrictions, but there's still a long way to go when it comes to compensation for forced laborers. We can't make any offer that the victims do not agree to.\" China, meanwhile, is expected to pressure Korea over the mooted deployment of mid-range American missiles here. One diplomatic source said Chinese Foreign Minister Wang Yi, who visited Seoul early this month, said the deployment must not happen. China remains upset that Seoul permitted the U.S. to station a Terminal High Altitude Area Defense battery here in late 2016, ostensibly because it fears that the battery's powerful radar will be used to spy on its military maneuvers.")
ex_2_coded = list(role= "assistant",
            content = "Topic: forced labor dispute\nEvent: Diplomatic Summit\nEvent Hostility: Cooperative\nCategory: Diplomacy: ROK, Japan\nMaterial Action: No\nCountry Sentiment: ROK=Neutral, Japan=Negative (weak) \nDirection: ROK to Japan\nGovernment Actors: Moon Jae-In (ROK), Shinzo Abe (Japan)\nGovernment Rhetoric: ROK=Yes (President, Cheong Wa Dae official), Japan=Yes (Prime Minister)\nNationalistic: Yes (forced labor)\n\nTopic: deployment of American missiles\nEvent: Diplomatic Summit\nEvent Hostility: Cooperative\nCategory: Diplomacy\nMaterial Action: No\nCountry Sentiment: PRC=Neutral, ROK=Negative (moderate)\nDirection: PRC to ROK\nGovernment Actors: Wang Yi (PRC), None (ROK)\nGovernment Rhetoric: PRC=Yes (Foreign Minister), ROK = No\nNationalistic: No\n###")
ex_3 = list(role = "user",
            content = "China on Thursday called for a peaceful settlement of an incident in which one Chinese fisherman died and two went missing after their trawler rammed a South Korean Coast Guard patrol boat and capsized on Dec. 18. Eight other fishermen were rescued from the water, but one later died. Chinese Foreign Ministry spokeswoman Jiang Yu claimed South Korea \"hopes to seek a peaceful settlement of this incident through negotiations, expressing regret over it several times.\" \"We're maintaining communication with the South Korean government. We hope that the two sides will settle it peacefully,\" she told reporters. Diplomats in Beijing said Jiang's choice of the word \"regret\" could be misunderstood as an apology, whereas Seoul in fact only expressed condolences over the death of Chinese fishermen. A South Korean government official said, \"It's a shame that China issued a statement that could cause misunderstanding and might look as if we had apologized, even though we only expressed condolences over the death of the fishermen.\" The Chinese boat was apparently trying to prevent South Korean coast guards from boarding another Chinese trawler that was suspected of fishing in South Korean waters without a permit and whose crew attacked coast guards with steel pipes. Meanwhile, when asked whether President Lee Myung-bak's visit to the site of a South Korean military drill site and his encouragement of troops there that day run counter to China's call for peace and stability, Jiang only said China hopes Lee \"will do things that encourage peace and promote dialogue.\"")
ex_3_coded = list(role= "assistant",
            content= "Topic: Fisherman Incident\nEvent: Coast Guard and Fisherman crash\nEvent Hostility: Conflictual\nCategory: Security\nMaterial Action: Yes\nCountry Sentiment: PRC=Neutral, ROK=Positive (moderate)\nDirection: PRC to ROK\nGovernment Actors: Jiang Yu (PRC), None (ROK)\nGovernment Rhetoric: PRC=Yes (Foreign Ministry Spokeswoman), ROK=Yes (Government Official)\nNationalistic: No \n\nTopic: Chinese Reaction to Military Drills\nEvent: South Korean Military Drills\nEvent Hostility: Conflictual\nCategory: Security\nMaterial Action: Yes\nCountry Sentiment: PRC=Neutral, ROK=Positive (moderate)\nDirection: PRC to ROK\nGovernment Actors: Jiang Yu (PRC), Lee Myung Bak (ROK) \nGovernment Rhetoric: PRC=Yes (Foreign Ministry Spokeswoman), ROK=No\nNationalistic: No\n###")
ex_4 = list(role= "user",
            content= "Foreign Minister Koichiro Genba said Tuesday he strongly hopes to establish a Japan-U.S.-China framework to deal with Asia-Pacific issues. During his foreign policy speech in the Diet, Genba stressed that while Japan-U.S. relations will continue to be the core of the nation's diplomacy and security, the two countries need to include China to establish an ''open and multitiered network'' in the Asia-Pacific region to maximize its growth opportunity and minimize risk. ''It is important not only for the region but for the stability and prosperity of the world for China to play a constructive role,'' Genba said. ''Now, more than ever, holding strategic dialogue and cooperation between Japan, the U.S. and China is important for the peace and stability of the region . . . and I would like to start up a trilateral dialogue, as I proposed last year.'' Genba cited South Korea as ''the most important neighbor, which shares fundamental values,'' although bilateral ties have seen some friction over the ''comfort women'' issue, which pertains to the Japanese military's wartime sex slaves, and the sovereignty dispute over Takeshima, a group of islets controlled by South Korea, which calls them Dokdo, but claimed by Japan. ''Difficult problems may arise at times, but both Japan and South Korea need to be future-oriented and cooperate from a broader viewpoint,'' Genba said. But he was firm on Takeshima. ''The Takeshima issue is not something that can be resolved in a short period of time, but it goes without saying that I will tenaciously take measures and be firm in telling South Korea what we cannot accept,'' he said. Genba also briefly mentioned that the government would submit Japan's ratification to the 1980 Hague Convention on the Civil Aspects of International Child Abduction and necessary legislation to the Diet. He did not elaborate, however, about what the government intends to do about the current cases of children who had been abducted to or from Japan, even though the treaty can't be applied retroactively.")
ex_4_coded = list(role= "assistant",
                  content = "Topic: Japan-US-China Framework\nEvent: Foreign policy speech in the Diet \nEvent Hostility: Neutral\nCategory: Diplomacy\nMaterial Action: No\nCountry Sentiment: Neutral, Positive (moderate), Positive (moderate)\nDirection: Japan to USA\nGovernment Actors: Koichiro Genba (Japan)\nGovernment Rhetoric: Japan=Yes (Foreign Minister), USA=No, PRC=No\nNationalistic: No\n\nTopic: Takeshima issue\nEvent: Foreign policy speech in the Diet \nEvent Hostility: Neutral\nCategory: Diplomacy\nMaterial Action: No: Japan, ROK\nCountry Sentiment: Neutral, Negative (moderate)\nDirection: Japan to ROK\nGovernment Actors: Koichiro Genba (Japan)\nGovernment Rhetoric: Japan=Yes (Foreign Minister), ROK=No\nNationalistic: Yes (Takeshima)\n###")
ex_5 = list(role="user",
            content="Uncertainties over relations between China and the United States caused by trade frictions and issues related to the Xinjiang Uygur autonomous region and Hong Kong remain the biggest challenge for Beijing's diplomatic efforts next year, according to senior experts. They said this was despite recent positive signs emerging from the trade talks with the US. In a phone call on Dec 20, President Xi Jinping and his US counterpart Donald Trump set the tone for how Beijing and Washington should deal with their frictions after the two countries reached a phase one trade deal. Both leaders said this initial economic and trade agreement benefited China, the US and the whole world. According to the Ministry of Commerce, the two countries are working on procedures, such as a legal review, translation and proofreading of the preliminary agreement regarding the phase one deal, and are closely communicating on follow-up measures. Tao Wenzhao, a researcher with the Institute of American Studies at the Chinese Academy of Social Sciences, said he was not optimistic about Sino-US relations from a short term perspective. Political parties in the US have reached consensus on two issues - that the US should adopt tougher policies toward China, and that neither country should \"crush the other completely\", Tao said. He added that the political parties had not reached consensus on many other issues, such as whether China is an economic rival of the US, if a trade war could benefit or harm the US, and whether China wants to assume the US' dominant position on global affairs. In June, an open letter to Trump and members of Congress signed by 100 leading US specialists on China, including scholars and former government officials, was published. It expressed deep concern over the growing deterioration of US relations with China, which it said \"does not serve American or global interests\". Tao said that since the letter had been published, many US experts and former officials had expressed views that differed to those of their government. \"From the mid-and long-term perspective, we should not be pessimistic,\" he said, adding that China has witnessed a remarkable increase in its economic, technological and international influence, which means that the country is more capable of handling relations with the US. Chen Fengying, a senior researcher on the world economy at the China Institute of Contemporary International Relations, said Beijing should \"increase its capability\" of dealing with US relations. Wu Xinbo, director of the Center for American Studies and dean of the Institute of International Studies at Fudan University in Shanghai, said the US is likely to adopt tougher and more confrontational policies toward China. He told a seminar in the middle of this month that preventing China's rise is an issue that is being agreed on increasingly by political parties in the US. Wu noted that the four high-level dialogue mechanisms on diplomacy and security, economy, law enforcement and cybersecurity, and social and people-to-people exchanges, set by the leaders of China and the US in April 2017, had all come to a stand still this year amid the tension caused by trade frictions. The rise of emerging powers, especially China, had caused the US to fret about its power being weakened, so Washington had resorted to containment policies toward Beijing, Wu said.")
ex_5_coded = list(role= "assistant",
                  content="Topic: Trade Agreement\nEvent: Presidential Phone call\nEvent Hostility: Cooperative\nCategory: Diplomacy\nMaterial Action: No\nCountry Sentiment: PRC=Neutral, US=Positive (moderate)\nDirection: PRC to USA\nGovernment Actors: Xi Jingping (PRC)\nGovernment Rhetoric: PRC=Yes (President, Ministry of Commerce), US=No\nNationalistic: No\n###")
ex_6 = list(role= "user",
            content= "Sixty-seven international non-governmental organizations including Amnesty International and Human Rights Watch, wrote to President Moon Jae-in on Monday raising concerns over the South Korean government's \"increasing disengagement with ongoing human rights violations\" by North Korea. The letter was also signed by 10 senior figures including Tom’s Ojea Quintana, the UN special rapporteur on human rights in North Korea. “Pyongyang might get the mistaken impression that the South Korean government is willing to overlook their illicit behavior in exchange for increased willingness to engage in the inter-Korean dialogue,\" the letter said. “We note that the improvement in human rights protections cannot take place just with the promotion of dialogue, cultural exchanges or development projects. We are also concerned by an approach that wrongly assumes achieving peace or improving inter-Korean cooperation depends on avoiding all official discussion of North Korean human rights violations. Stepping back from these necessary human rights discussions will only embolden those in North Korea's leadership who are responsible for the worst abuses.” “Integrating fundamental human rights into the current negotiations is crucial for the sustainability of any agreement for denuclearization and peace for the Korean Peninsula and beyond,” it added.")
ex_6_coded = list(role= "assistant",
                  content="Topic: Human Rights\nEvent: IGO letter to ROK President\nEvent Hostility: Neutral\nCategory: Human Rights\nCountry Sentiment: ROK=Negative (weak), DPRK=Negative (weak)\nDirection: International NGOs to ROK\nMaterial Action: No\nGovernment Actors: Moon Jae-In, NA\nGovernment Rhetoric: ROK=No, DPRK=No \nNationalistic: No \n###")
ex_7 = list(role= "user",
            content="As the Christmas season has passed and 2019 draws to a close, those who were worried about the Democratic People's Republic of Korea's ominous threat of a \"Christmas gift\" for the United States might be heaving a sigh of relief. Yet there is still the year-end deadline the DPRK's top leader set for Washington on denuclearization talks. Hopefully, despite the tough words and actions - the DPRK carried out two \"important tests\" at a satellite launching ground earlier this month, and the US has recently sent more surveillance aircraft to the peninsula - both sides will remain restrained and not do anything that might blow the chance for a diplomatic solution. As White House National Security Advisor Robert O'Brien said on Sunday, \"channels of communication\" between the two countries are still open. More important, the DPRK has so far restrained itself from lifting a moratorium on nuclear and long-range missile tests, which is considered a red line it must not cross if any denuclearization hope is to survive. Which may give cause for optimism that it was DPRK top leader Kim Jong-un applying pressure on Washington when he called for his military and diplomats to prepare unspecified \"offensive measures\" to protect the country's security and sovereignty during a key meeting on Sunday. Especially, as his proclaimed focus on the country's economy may also serve as a proof that the possibility of a return to the old path of nuclear adventurism is slim. Kim \"stressed the need to reasonably straighten the country's economic work system and order\" while seeking a \"decisive\" increase in agricultural production and improving science, education and public health standards, according to the state news agency KCNA. Attaining these goals would be out of the question if a nuclear confrontation re-emerges. But that does not mean Washington should continue to press ahead with all the sanctions and pressure it is already applying against Pyongyang without making any substantial moves to address the latter's existential concerns. The US may insist the DPRK is not doing enough in denuclearization, but there remains a discrepancy in understanding about how that process should unfold. The hard-handed method adopted by the US has only deepened distrust, and compounded the DPRK's fears that it will get nothing in return for abandoning nuclear capability. Thus to solve the stalemate, China and Russia proposed a draft UN Security Council resolution earlier this month that would lift some sanctions so as to restart the stalled denuclearization talks. The US should consider giving the proposal a chance. After all, keeping the peace momentum on the Korean Peninsula going caters to its interests as well.")
ex_7_coded = list(role="assistant",
                  content="Topic: US-DPRK Denuclearization Talks\nEvent: Public Statements\nEvent Hostility: Neutral\nCategory: Diplomacy\nMaterial Action: No\nCountry Sentiment: DPRK=Positive (weak), US=Negative (moderate)\nDirection: DRPK to US, US to DPRK\nGovernment Actors: Kim Jong Un, Robert O’brien\nGovernment Rhetoric: DPRK=Yes (Leader), US=Yes (National Security Advisor)\nNationalistic: No \n###")
ex_8 = list(role = "user",
            content= "Tokyo has asked Seoul to respond within 30 days to its request for diplomatic talks over court rulings on the use of wartime forced labor by Japanese companies, according to a South Korean media report. Japan made the request Wednesday, the South's Yonhap news agency quoted government sources in Seoul as saying Sunday, after a court in South Korea approved the seizure of Nippon Steel & Sumitomo Metal Corp. assets in the country in relation to a ruling over forced labor during Japan's colonial rule of the peninsula from 1910-1945. The report came just days after diplomatic sources in Tokyo indicated that the issue has also been raised by Pyongyang. Tokyo and Seoul have been engaged in an intensifying dispute since October, when South Korea's Supreme Court ordered Nippon Steel to compensate four South Korean nationals for wartime forced labor and then handed a similar ruling to Mitsubishi Heavy Industries Ltd. the following month. Japan has refused to comply with the rulings based on its position that the matter of compensation for wartime labor was resolved under a 1965 agreement normalizing relations with South Korea. Last week, Tokyo formally requested that Seoul launch consultations, to which South Korea said it would review the request carefully. With Japan said to have insisted on the fixed schedule, the South Korean government has apparently said it \"will not be tied down by the 30-day window\" to make any decision, according to the Yonhap report that quotes unidentified sources. Japan's call for the talks is based on Article III of the 1965 treaty between Seoul and Tokyo. The agreement stipulates that any dispute related to the treaty must be settled by the two sides primarily through diplomatic channels. Tokyo has argued that all issues over reparation related to its rule of what is now known as South Korea were settled via the pact. However, the treaty does not specify any deadline within which to arrange diplomatic talks. Under the pact, if the two countries are unable to reach a resolution through diplomatic talks, they must form an arbitration committee together with a third party to settle disputes. In that event, Tokyo and Seoul must appoint representatives \"within a period of thirty days from the date of receipt by the Government of either Contracting Party from the Government of the other of a note requesting arbitration of the dispute,\" according to the treaty. It was unclear if the reported request by Japan was referring to the formation of such an arbitration committee. The third party arbitrator must be agreed upon by Japan and South Korea \"within a further period of thirty days\" or appointed by the government of a third, agreed-upon country within that period. The third party arbitrator cannot be a national of either side. The reports came the day after diplomatic sources in Tokyo revealed that North Korea had threatened to raise the issue of wartime forced labor in future bilateral talks if Tokyo continues to pursue the issue of Pyongyang's abductions of Japanese citizens in the 1970s and 1980s, according to a report by Kyodo News that cited unidentified diplomatic sources. In recent weeks, Pyongyang has repeatedly criticized Japan's stance over the issue in state-run media. According to the sources, North Korean Foreign Minister Ri Yong Ho warned that if Tokyo continues to focus on the abductions, he would bring up the issue of the \"more than 8.4 million Koreans who were forced to work\" under Japanese colonial rule, the sources said. While Tokyo normalized bilateral ties with Seoul under their 1965 agreement, Japan does not have any diplomatic relationship with nuclear-armed North Korea. Abe said last week that his government is \"using various channels\" to communicate with Pyongyang, including over a potential summit with leader Kim Jong Un. For his part, Kim, too, appears interested in talks with Abe, telling South Korean President Moon Jae-in in April last year that he is ready to hold a dialogue with Japan at \"any time.\" However, Abe has said time after time that Japan will hold back any economic incentives until all of its concerns the nuclear, missile and abduction issues resolved. Experts say that comments by the North, which has cultivated closer ties with the South over the last year, reveal important elements regarding its posture toward relations with Tokyo. \"First, Pyongyang feels that it has considerable leverage right now with Japan considering its warmer relations with South Korea  which is in the midst of its own nasty row with Japan over history and other issues again and also its ties with both China and the U.S.,\" said J. Berkshire Miller, a senior visiting fellow with the Japan Institute of International Affairs in Tokyo. \"Frankly put, there is no urgency for North Korea to resolve matters with Japan on the abductions matter and they are playing their hand in a different way.\" Pyongyang is also using the timing to hammer away at increasingly brittle trilateral ties between Seoul, Tokyo and Washington. \"The North is using the approach of critiquing Tokyo as it has done for decades to further weaken and exploit cracks in a weakening trilateral front between the U.S., Japan and South Korea which are supposed to be on the same page regarding the denuclearization of North Korea,\" Miller said.")

ex_8_coded = list(role= "assistant",
                  content= "Topic: Japan-South Korea Diplomatic Dispute\nEvent: Request for Diplomatic Talks\nEvent Hostility: Conflictual\nCategory: Diplomacy\nMaterial Action: No\nCountry Sentiment: ROK=Negative (strong), Japan=Negative (strong), DPRK=Negative (moderate)\nDirection: Japan to ROK, DPRK to Japan\nGovernment Actors: Unnamed sources (ROK), Unnamed sources (Japan), Ri Yong Ho (DPRK)\nGovernment Rhetoric: ROK=No, Japan=No, DPRK=Yes (Foreign Minister)\nNationalistic: Yes (forced labor)")

### full context
context = list(instructions,
               ex_1, ex_1_coded, ex_2, ex_2_coded, ex_3, ex_3_coded, ex_4, ex_4_coded, ex_5, ex_5_coded,
               ex_6, ex_6_coded, ex_7, ex_7_coded )#, ex_8, ex_8_coded)


####load data: China
load("../Data/Feb 2023/xinchi_feb.Rdata")
#write.csv(xinchi, file = "../Data/Feb 2023/xinchi_feb.csv")
###load data: ROK
#doesnt have date cleaning or regex cleaning yet
load("../Data/Feb 2023/chosko_feb.Rdata")
write.csv(chosko, file = "../Data/Feb 2023/chosko_feb.csv")
test = read.csv("../Data/Feb 2023/chosko_feb.csv")
head(test)
###sample 20%
n_xinchi = nrow(xinchi)
xinchi_20p = round(n_xinchi*.2)
n_chosko = nrow(chosko)
chosko_20p = round(n_chosko*.2)
set.seed(340920)
samp_xinchi = sample(n_xinchi, xinchi_20p)
#samp_xinchi[1:5]
samp_chosko = sample(n_chosko, chosko_20p)
#### run:
#note that a lot of xinchi's end with "(finish)" should i remove that?
#fix ex_8
#parallelize?
#shit log probs are only in latest update in python? ok well python path is fucked so that's failing also

xinchi_coded = cbind(xinchi, data.frame(index = NA, 
                                        logprobs =NA,
                                        finish_reason = NA_character_,
                                        message.role = NA_character_,
                                        message.content = NA_character_))
ncol(xinchi_coded)
req_cols = 18:22
req_cols
coding = NULL
coding= data.frame()
coding = list
running_tot = 0
#filter based on regex to ONLY foreign news to save some dollars?
for(i in 1:3) {
    cat("Xinchi Article:", i, "\t", round(i/xinchi_20p*100, 2), "% of 20p sample\n")
    current = xinchi[samp_xinchi[i],]
    append_current = c(context, list(list(role = "user", content = current$translatedText)))
    request = create_chat_completion(
        model = "gpt-3.5-turbo-1106",
        messages = append_current,
        max_tokens = 725,
        temperature = 0,
        stop = "\n###",
        presence_penalty = 0,
        frequency_penalty = 0)
    current_cost = request$usage$prompt_tokens/1000*0.0010 + request$usage$completion_tokens/1000*0.0020
    running_tot = running_tot + current_cost
    cat("\t\t est request cost:", current_cost, "\t est total cost:", running_tot, "\n")
    #this wont capture choices as wtihin data.frame
    #coding = rbind(coding, request)
    coding[i] = list(request)
    #this works but then doubles everything a million times in the bind_rows()
    #coding[i] = rbind(requests)
    xinchi_coded[samp_xinchi[i], req_cols] = request$choices
}

#raw codings here: it's a little messy, if you want everyhting need to lapply through the indecies but it works....
t = lapply(coding, `[`,5) %>% dplyr::bind_rows()
t$choices$message.content

xinchi_coded[samp_xinchi[3],] 
